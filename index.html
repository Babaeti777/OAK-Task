<!DOCTYPE html>
<html lang="en">
<head>
     <meta charset="UTF-8">
     <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
     <title>Eisenhower Matrix - AI Task Manager</title>
     <script src="https://cdn.tailwindcss.com"></script>
     <link rel="preconnect" href="https://fonts.googleapis.com">
     <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
     <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
     <style>
         body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
         .quadrant-1-border { border-color: #ef4444 !important; }
         .quadrant-2-border { border-color: #3b82f6 !important; }
         .quadrant-3-border { border-color: #f97316 !important; }
         .quadrant-4-border { border-color: #6b7280 !important; }
         .quadrant-1-text { color: #ef4444 !important; }
         .quadrant-2-text { color: #3b82f6 !important; }
         .quadrant-3-text { color: #f97316 !important; }
         .quadrant-4-text { color: #6b7280 !important; }
         .quadrant-1-bg { background-color: #ef4444 !important; }
         .quadrant-2-bg { background-color: #3b82f6 !important; }
         .quadrant-3-bg { background-color: #f97316 !important; }
         .quadrant-4-bg { background-color: #6b7280 !important; }
         .task.overdue { background-color: #fef2f2; border-left-color: #ef4444; }
         .task.running { box-shadow: 0 0 0 2px #3b82f6; background-color: #dbeafe; }
         .drag-over { transform: scale(1.02); background-color: #eff6ff; }
         .task.dragging { opacity: 0.5; }
         .modal { transition: opacity 0.25s ease; }
         .modal-content { transition: transform 0.25s ease; }
         .task-title-input { width: 100%; padding: 2px; border-radius: 4px; border: 1px solid #cbd5e1; outline: none; font-weight: 600; }
         .task-title-input:focus { border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4); }
         .spinner { border-top-color: #ffffff; animation: spin 1s linear infinite; }
         @keyframes spin { to { transform: rotate(360deg); } }
         #timer-fullscreen-display {
             font-size: clamp(4rem, 25vw, 12rem);
             font-variant-numeric: tabular-nums;
             text-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
         }
         .pulse-animation {
             animation: pulse 4s ease-in-out infinite;
         }
         @keyframes pulse {
             0% { transform: scale(1); opacity: 0.7; }
             50% { transform: scale(1.05); opacity: 1; }
             100% { transform: scale(1); opacity: 0.7; }
         }
     </style>
 </head>
 <body class="bg-gradient-to-br from-gray-50 to-gray-200">
 
     <div id="configWarning" class="hidden px-4 py-3 text-sm font-medium text-center text-red-800 bg-red-100 border-b-2 border-red-200"></div>
     
     <div id="main-content">
         <div class="min-h-screen p-4 mx-auto max-w-7xl sm:p-6 lg:p-8">
             <header class="mb-8 text-center">
                 <h1 class="text-4xl font-bold tracking-tight text-gray-800 sm:text-5xl">Eisenhower Matrix</h1>
                 <p class="mt-2 text-lg text-gray-600">AI-Powered Task Management.</p>
                <p class="mt-4 text-sm text-gray-500">Manage your tasks, edit details inline, and keep everything in sync with Excel exports.</p>
             </header>
             <div class="grid grid-cols-1 gap-6 mb-8 lg:grid-cols-3">
                 <div class="p-6 bg-white border border-gray-200 rounded-2xl shadow-lg lg:col-span-2">
                     <h2 class="text-lg font-semibold text-gray-800">Add a New Task</h2>
                      <form id="addTaskForm" class="mt-4" onsubmit="TaskManager.addTask(event)">
                         <div class="mb-4">
                             <label for="taskTitle" class="text-sm font-medium text-gray-600">Task Title</label>
                             <input type="text" id="taskTitle" placeholder="e.g., Finish project proposal" class="w-full px-4 py-2 mt-1 text-gray-800 bg-gray-100 border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                         </div>
                         <div class="grid grid-cols-1 gap-4 sm:grid-cols-3">
                             <div>
                                 <label for="taskQuadrant" class="text-sm font-medium text-gray-600">Priority</label>
                                 <select id="taskQuadrant" class="w-full px-4 py-2 mt-1 text-gray-800 bg-gray-100 border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                     <option value="1">üî• Urgent & Important</option>
                                     <option value="2" selected>üìÖ Important</option>
                                     <option value="3">‚ö° Urgent</option>
                                     <option value="4">üóëÔ∏è Eliminate</option>
                                 </select>
                             </div>
                             <div>
                                 <label for="taskTime" class="text-sm font-medium text-gray-600">Est. Minutes</label>
                                 <input type="number" id="taskTime" value="25" min="5" class="w-full px-4 py-2 mt-1 text-gray-800 bg-gray-100 border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                             </div>
                             <div>
                                 <label for="taskDueDate" class="text-sm font-medium text-gray-600">Due Date</label>
                                 <input type="date" id="taskDueDate" class="w-full px-4 py-2 mt-1 text-gray-800 bg-gray-100 border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                             </div>
                         </div>
                         <button type="submit" class="w-full px-6 py-3 mt-6 font-semibold text-white bg-blue-600 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Add Task</button>
                     </form>
                 </div>
                 <div class="p-6 bg-white border border-gray-200 rounded-2xl shadow-lg">
                      <h2 class="text-lg font-semibold text-gray-800">Options</h2>
                      <div class="mt-4 space-y-4">
                          <label class="flex items-center justify-between p-4 bg-gray-100 rounded-lg cursor-pointer">
                             <span class="font-medium text-gray-700">Hide Completed Tasks</span>
                             <div class="relative inline-flex items-center cursor-pointer">
                                 <input type="checkbox" id="hideCompleted" class="sr-only peer" onchange="TaskManager.render()">
                                 <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-4 peer-focus:ring-blue-300 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                             </div>
                         </label>
                        <button onclick="ExcelService.exportTasks()" class="flex items-center justify-center w-full gap-2 px-4 py-2 font-semibold text-white transition bg-green-600 rounded-lg shadow hover:bg-green-700">
                            <span>‚¨áÔ∏è Export Tasks to Excel</span>
                        </button>
                        <button onclick="document.getElementById('importFileInput').click()" class="flex items-center justify-center w-full gap-2 px-4 py-2 font-semibold text-white transition bg-blue-600 rounded-lg shadow hover:bg-blue-700">
                            <span>‚¨ÜÔ∏è Import Tasks from Excel</span>
                        </button>
                        <input type="file" id="importFileInput" accept=".xlsx,.xls" class="hidden" onchange="ExcelService.handleFileUpload(event)">
                      </div>
                 </div>
             </div>
             <main class="grid grid-cols-1 gap-6 md:grid-cols-2 lg:gap-8">
                 <div class="quadrant quadrant-1 bg-white border-t-4 border-gray-200 rounded-2xl shadow-lg" data-quadrant="1" ondrop="TaskManager.drop(event)" ondragover="TaskManager.allowDrop(event)" ondragleave="TaskManager.dragLeave(event)">
                     <div class="flex items-center justify-between p-4 border-b border-gray-200"><h3 class="text-lg font-bold quadrant-1-text">üî• Urgent & Important (Do)</h3><div id="count-1" class="px-3 py-1 text-sm font-bold text-white rounded-full quadrant-1-bg">0</div></div><div id="tasks-1" class="p-4 space-y-3"></div>
                 </div>
                 <div class="quadrant quadrant-2 bg-white border-t-4 border-gray-200 rounded-2xl shadow-lg" data-quadrant="2" ondrop="TaskManager.drop(event)" ondragover="TaskManager.allowDrop(event)" ondragleave="TaskManager.dragLeave(event)">
                     <div class="flex items-center justify-between p-4 border-b border-gray-200"><h3 class="text-lg font-bold quadrant-2-text">üìÖ Important (Schedule)</h3><div id="count-2" class="px-3 py-1 text-sm font-bold text-white rounded-full quadrant-2-bg">0</div></div><div id="tasks-2" class="p-4 space-y-3"></div>
                 </div>
                 <div class="quadrant quadrant-3 bg-white border-t-4 border-gray-200 rounded-2xl shadow-lg" data-quadrant="3" ondrop="TaskManager.drop(event)" ondragover="TaskManager.allowDrop(event)" ondragleave="TaskManager.dragLeave(event)">
                     <div class="flex items-center justify-between p-4 border-b border-gray-200"><h3 class="text-lg font-bold quadrant-3-text">‚ö° Urgent (Delegate)</h3><div id="count-3" class="px-3 py-1 text-sm font-bold text-white rounded-full quadrant-3-bg">0</div></div><div id="tasks-3" class="p-4 space-y-3"></div>
                 </div>
                 <div class="quadrant quadrant-4 bg-white border-t-4 border-gray-200 rounded-2xl shadow-lg" data-quadrant="4" ondrop="TaskManager.drop(event)" ondragover="TaskManager.allowDrop(event)" ondragleave="TaskManager.dragLeave(event)">
                     <div class="flex items-center justify-between p-4 border-b border-gray-200"><h3 class="text-lg font-bold quadrant-4-text">üóëÔ∏è Neither (Eliminate)</h3><div id="count-4" class="px-3 py-1 text-sm font-bold text-white rounded-full quadrant-4-bg">0</div></div><div id="tasks-4" class="p-4 space-y-3"></div>
                 </div>
             </main>
         </div>
     </div>
 
     <!-- Timer Fullscreen Overlay -->
     <div id="timer-fullscreen" class="fixed inset-0 z-50 flex-col items-center justify-center hidden text-white opacity-0">
         <div class="text-center pulse-animation">
             <h2 id="timer-fullscreen-task-title" class="mb-4 text-4xl font-semibold opacity-80"></h2>
             <div id="timer-fullscreen-display" class="font-bold">25:00</div>
         </div>
         <div class="absolute flex gap-4 bottom-10">
             <button id="timer-fullscreen-pause" onclick="Timer.pause()" class="px-6 py-3 font-semibold text-white bg-white bg-opacity-20 rounded-lg hover:bg-opacity-30">Pause</button>
             <button id="timer-fullscreen-start" onclick="Timer.start()" class="hidden px-6 py-3 font-semibold text-white bg-white bg-opacity-20 rounded-lg hover:bg-opacity-30">Resume</button>
             <button onclick="Timer.stop()" class="px-6 py-3 font-semibold text-white bg-red-500 rounded-lg hover:bg-red-600">Stop & Exit</button>
         </div>
     </div>
 
 
     <div id="detailsModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 transition-opacity duration-300 bg-black bg-opacity-50 opacity-0 pointer-events-none modal">
         <div class="w-full max-w-lg p-6 bg-white modal-content rounded-2xl shadow-2xl scale-95 transform-gpu transition-transform duration-300">
             <div class="flex items-center justify-between pb-3 border-b border-gray-200">
                 <h3 id="detailsTitle" class="text-2xl font-bold text-gray-800">Task Details</h3>
                 <button onclick="UI.closeDetailsModal()" class="p-1 text-gray-400 rounded-full hover:bg-gray-200 hover:text-gray-600">&times;</button>
             </div>
            <div class="mt-4 space-y-6">
                <div class="space-y-4">
                    <div>
                        <label for="detailTitleInput" class="text-sm font-medium text-gray-600">Task Title</label>
                        <input id="detailTitleInput" type="text" class="w-full px-3 py-2 mt-1 bg-gray-100 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="Update the task title">
                    </div>
                    <div class="grid grid-cols-1 gap-4 sm:grid-cols-3">
                        <div>
                            <label for="detailQuadrantSelect" class="text-sm font-medium text-gray-600">Priority</label>
                            <select id="detailQuadrantSelect" class="w-full px-3 py-2 mt-1 bg-gray-100 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                                <option value="1">üî• Urgent & Important</option>
                                <option value="2">üìÖ Important</option>
                                <option value="3">‚ö° Urgent</option>
                                <option value="4">üóëÔ∏è Eliminate</option>
                            </select>
                        </div>
                        <div>
                            <label for="detailTimeInput" class="text-sm font-medium text-gray-600">Est. Minutes</label>
                            <input id="detailTimeInput" type="number" min="5" class="w-full px-3 py-2 mt-1 bg-gray-100 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="detailDueDateInput" class="text-sm font-medium text-gray-600">Due Date</label>
                            <input id="detailDueDateInput" type="date" class="w-full px-3 py-2 mt-1 bg-gray-100 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    <label class="inline-flex items-center gap-2 text-sm font-medium text-gray-600">
                        <input id="detailCompletedCheckbox" type="checkbox" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
                        Mark as completed
                    </label>
                    <div class="flex justify-end">
                        <button onclick="TaskManager.saveDetails()" class="flex items-center gap-2 px-4 py-2 text-sm font-semibold text-white bg-blue-600 rounded-md shadow hover:bg-blue-700">
                            <span>üíæ Save Changes</span>
                        </button>
                    </div>
                </div>
                <div class="pt-4 border-t border-gray-200">
                     <div class="flex items-center justify-between">
                         <h4 class="font-semibold text-gray-700">Sub-tasks</h4>
                         <button id="generateSubtasksBtn" onclick="GeminiService.generateSubtasks()" class="flex items-center gap-1 px-2 py-1 text-xs font-semibold text-white bg-purple-500 rounded-md hover:bg-purple-600">
                             <span class="btn-text">‚ú® Smart Sub-tasks</span>
                             <div class="hidden w-4 h-4 border-2 border-t-transparent border-white rounded-full spinner"></div>
                         </button>
                     </div>
                     <div id="subtasksContainer" class="mt-2 space-y-2"></div>
                     <div class="flex gap-2 mt-2">
                         <input type="text" id="newSubtaskInput" placeholder="Add a new sub-task..." class="flex-grow px-3 py-1 bg-gray-100 border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                         <button onclick="TaskManager.addSubtask()" class="px-3 py-1 font-semibold text-white bg-blue-500 rounded-md hover:bg-blue-600">Add</button>
                     </div>
                 </div>
                <div class="pt-4 border-t border-gray-200">
                      <div class="flex items-center justify-between">
                         <h4 class="font-semibold text-gray-700">Notes</h4>
                         <button id="generateNotesBtn" onclick="GeminiService.generateNotes()" class="flex items-center gap-1 px-2 py-1 text-xs font-semibold text-white bg-purple-500 rounded-md hover:bg-purple-600">
                              <span class="btn-text">‚ú® Generate Notes</span>
                              <div class="hidden w-4 h-4 border-2 border-t-transparent border-white rounded-full spinner"></div>
                         </button>
                     </div>
                     <textarea id="taskNotes" rows="4" class="w-full p-2 mt-2 bg-gray-100 border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="Add any notes here..."></textarea>
                 </div>
             </div>
              <div class="flex justify-end mt-6">
                <button onclick="UI.closeDetailsModal()" class="px-6 py-2 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">Close</button>
             </div>
         </div>
     </div>
     
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

     <script>
     // --- CONFIGURATION --- //
     let GEMINI_API_KEY = "";
     
     // --- GEMINI AI SERVICE --- //
     const GeminiService = {
         setLoadingState(buttonId, isLoading) {
             const button = document.getElementById(buttonId);
             if (button) {
                 const text = button.querySelector('.btn-text');
                 const spinner = button.querySelector('.spinner');
                 if (isLoading) {
                     text.classList.add('hidden');
                     spinner.classList.remove('hidden');
                     button.disabled = true;
                 } else {
                     text.classList.remove('hidden');
                     spinner.classList.add('hidden');
                     button.disabled = false;
                 }
             }
         },
         async call(prompt) {
             if (!GEMINI_API_KEY) {
                 const key = prompt("Please enter your Gemini API Key. You can get one from Google AI Studio.");
                 if (key) {
                     GEMINI_API_KEY = key;
             if (result) {
                 result.split(',').forEach(subtaskText => {
                     if (subtaskText.trim()) {
                         TaskManager.addSubtask(subtaskText.trim(), true);
                     }
                 });
             }
             this.setLoadingState('generateSubtasksBtn', false);
         },
         async generateNotes() {
             this.setLoadingState('generateNotesBtn', true);
             const task = TaskManager.tasks.find(t => t.id === UI.currentDetailTaskId);
             if (!task) { this.setLoadingState('generateNotesBtn', false); return; }
 
             const promptText = `Generate helpful notes for the task: "${task.title}". The notes should be a short paragraph, offering a brief plan or key considerations.`;
             const result = await this.call(promptText);
             if (result) {
                 const notesArea = document.getElementById('taskNotes');
                 notesArea.value = result;
                 TaskManager.updateNotes(result);
             }
             this.setLoadingState('generateNotesBtn', false);
         }
     };
 
    // --- EXCEL IMPORT/EXPORT SERVICE --- //
    const ExcelService = {
        exportTasks() {
            if (!TaskManager.tasks.length) {
                UI.showNotification('No tasks available to export yet.', 'error');
                 return;
             }
            const worksheetData = TaskManager.tasks.map(task => ({
                ID: task.id,
                Title: task.title,
                Quadrant: task.quadrant,
                TimeBoxMinutes: task.timeBox,
                DueDate: task.dueDate ? new Date(task.dueDate).toISOString().split('T')[0] : '',
                Completed: task.completed,
                Notes: task.notes || '',
                Subtasks: JSON.stringify(task.subtasks || [])
            }));
            const worksheet = XLSX.utils.json_to_sheet(worksheetData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Tasks');
            XLSX.writeFile(workbook, 'tasks.xlsx');
            UI.showNotification('Tasks exported to Excel.', 'success');
        },
        handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) { return; }
            this.importTasks(file);
            event.target.value = '';
        },
        importTasks(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    if (!firstSheetName) {
                        UI.showNotification('The Excel file does not contain any sheets.', 'error');
                        return;
                    }
                    const worksheet = workbook.Sheets[firstSheetName];
                    const rows = XLSX.utils.sheet_to_json(worksheet, { defval: '', cellDates: true });
                    if (!rows.length) {
                        UI.showNotification('No task data found in the Excel file.', 'error');
                        return;
                    }

                    const parseDueDate = (value) => {
                        if (!value && value !== 0) { return null; }

                        if (value instanceof Date && !isNaN(value.getTime())) {
                            return new Date(Date.UTC(value.getFullYear(), value.getMonth(), value.getDate()));
                        }

                        if (typeof value === 'number') {
                            const parsed = XLSX.SSF.parse_date_code(value);
                            if (parsed) {
                                return new Date(Date.UTC(parsed.y, parsed.m - 1, parsed.d));
                            }
                        }

                        if (typeof value === 'string') {
                            const trimmed = value.trim();
                            if (!trimmed) { return null; }

                            const isoMatch = trimmed.match(/^(\d{4})-(\d{2})-(\d{2})$/);
                            if (isoMatch) {
                                const [, year, month, day] = isoMatch;
                                return new Date(Date.UTC(Number(year), Number(month) - 1, Number(day)));
                            }

                            const slashMatch = trimmed.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})$/);
                            if (slashMatch) {
                                const [, part1, part2, yearPart] = slashMatch;
                                let year = parseInt(yearPart, 10);
                                if (year < 100) {
                                    year += year >= 70 ? 1900 : 2000;
                                }
                                const month = parseInt(part1, 10);
                                const day = parseInt(part2, 10);
                                if (month >= 1 && month <= 12 && day >= 1 && day <= 31) {
                                    return new Date(Date.UTC(year, month - 1, day));
                                }
                            }

                            const fallback = new Date(trimmed);
                            if (!isNaN(fallback.getTime())) {
                                return new Date(Date.UTC(fallback.getFullYear(), fallback.getMonth(), fallback.getDate()));
                            }
                        }

                        return null;
                    };

                    const runParserSelfCheck = () => {
                        const samples = [
                            { label: 'Excel serial', value: 45123, expected: '2023-07-16' },
                            { label: 'ISO string', value: '2024-01-15', expected: '2024-01-15' },
                            { label: 'US string', value: '03/14/2025', expected: '2025-03-14' },
                        ];
                        console.groupCollapsed('Excel import date parser check');
                        samples.forEach(({ label, value, expected }) => {
                            const parsed = parseDueDate(value);
                            const actual = parsed ? parsed.toISOString().split('T')[0] : 'null';
                            console.log(`${label}:`, actual, '(expected:', expected + ')');
                        });
                        console.groupEnd();
                    };

                    if (typeof window !== 'undefined' && !window.__excelParserSelfChecked) {
                        window.__excelParserSelfChecked = true;
                        runParserSelfCheck();
                    }

                    const importedTasks = rows.map((row, index) => {
                        const parsedSubtasks = (() => {
                            if (!row.Subtasks) { return []; }
                            try {
                                const value = typeof row.Subtasks === 'string' ? row.Subtasks : JSON.stringify(row.Subtasks);
                                const json = JSON.parse(value);
                                if (Array.isArray(json)) {
                                    return json.map((subtask, idx) => ({
                                        id: typeof subtask.id === 'number' ? subtask.id : idx + 1,
                                        text: subtask.text || String(subtask),
                                        completed: Boolean(subtask.completed)
                                    }));
                                }
                            } catch (error) {
                                return String(row.Subtasks).split('|').map((text, idx) => ({ id: idx + 1, text: text.trim(), completed: false }));
                            }
                            return [];
                        })();

                        const normalizedDueDate = parseDueDate(row.DueDate);

                        return {
                            id: Number(row.ID) || index + 1,
                            title: row.Title ? String(row.Title).trim() : `Imported Task ${index + 1}`,
                            quadrant: Number(row.Quadrant) >= 1 && Number(row.Quadrant) <= 4 ? Number(row.Quadrant) : 2,
                            timeBox: Number(row.TimeBoxMinutes) > 0 ? Number(row.TimeBoxMinutes) : 25,
                            dueDate: normalizedDueDate ? new Date(Date.UTC(
                                normalizedDueDate.getUTCFullYear(),
                                normalizedDueDate.getUTCMonth(),
                                normalizedDueDate.getUTCDate()
                            )).toISOString() : null,
                            completed: String(row.Completed).toLowerCase() === 'true',
                            createdAt: new Date().toISOString(),
                            notes: row.Notes ? String(row.Notes) : '',
                            subtasks: parsedSubtasks
                        };
                    });

                    TaskManager.replaceTasks(importedTasks);
                    UI.showNotification('Tasks imported from Excel.', 'success');
                } catch (error) {
                    console.error('Error importing tasks from Excel:', error);
                    UI.showNotification('Failed to import tasks. Please verify the file format.', 'error');
                }
            };
            reader.onerror = () => UI.showNotification('Unable to read the selected file.', 'error');
            reader.readAsArrayBuffer(file);
        }
     };
     
     // --- TIMER --- //
    const Timer = {
        currentTask: null,
        duration: 0,
        remaining: 0,
        interval: null,
        isRunning: false,
        startFromTask(taskId, evt = null) {
            if (evt) evt.stopPropagation();
            const task = TaskManager.tasks.find(t => t.id === taskId);
            if (!task) return;

            if (this.currentTask && this.currentTask.id === taskId) {
                this.isRunning ? this.pause() : this.start();
                return;
            }

            if (this.isRunning || this.currentTask) {
                this.stop(true);
            }

            this.currentTask = task;
            this.duration = task.timeBox * 60;
            this.remaining = task.remainingTime || this.duration;
            this.showFullscreen();
            this.start();
        },
        start() {
            if (!this.currentTask) { return; }
            clearInterval(this.interval);
            this.isRunning = true;
            this.updateButtonState();
            this.updateFullscreenDisplay();
            this.interval = setInterval(() => {
                if (!this.isRunning) { return; }
                this.remaining = Math.max(this.remaining - 1, 0);
                this.updateFullscreenDisplay();
                if (this.currentTask) {
                    this.currentTask.remainingTime = this.remaining;
                }
                if (this.remaining === 0) {
                    this.stop();
                }
            }, 1000);
        },
        pause() {
            if (!this.isRunning) { return; }
            clearInterval(this.interval);
            this.interval = null;
            this.isRunning = false;
            if (this.currentTask) {
                this.currentTask.remainingTime = this.remaining;
                TaskManager.saveAndRender();
            }
            this.updateButtonState();
        },
        stop(skipRender = false) {
            clearInterval(this.interval);
            this.interval = null;
            this.isRunning = false;
            if (this.currentTask) {
                delete this.currentTask.remainingTime;
            }
            this.hideFullscreen();
            this.currentTask = null;
            this.duration = 0;
            this.remaining = 0;
            if (!skipRender) {
                TaskManager.saveAndRender();
            }
        },
        showFullscreen() {
            const timerScreen = document.getElementById('timer-fullscreen');
            if (!timerScreen) { return; }
            document.getElementById('main-content').classList.add('hidden');
            timerScreen.classList.remove('hidden');
            const animateIn = () => timerScreen.classList.remove('opacity-0');
            if (typeof requestAnimationFrame === 'function') {
                requestAnimationFrame(animateIn);
            } else {
                setTimeout(animateIn, 0);
            }
            document.getElementById('timer-fullscreen-task-title').textContent = this.currentTask?.title || '';
            this.updateButtonState();
            this.updateFullscreenDisplay();
        },
        hideFullscreen() {
            const timerScreen = document.getElementById('timer-fullscreen');
            if (!timerScreen) { return; }
            timerScreen.classList.add('opacity-0');
            setTimeout(() => timerScreen.classList.add('hidden'), 500);
            document.getElementById('main-content').classList.remove('hidden');
            this.updateButtonState();
        },
        updateButtonState() {
            const pauseBtn = document.getElementById('timer-fullscreen-pause');
            const startBtn = document.getElementById('timer-fullscreen-start');
            if (!pauseBtn || !startBtn) { return; }
            if (this.isRunning) {
                pauseBtn.classList.remove('hidden');
                startBtn.classList.add('hidden');
            } else {
                pauseBtn.classList.add('hidden');
                startBtn.classList.remove('hidden');
            }
        },
        updateFullscreenDisplay() {
            const formatTime = (seconds) => {
                if (seconds < 0) seconds = 0;
                const m = Math.floor(seconds / 60);
                const s = seconds % 60;
                return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            };
            document.getElementById('timer-fullscreen-display').textContent = formatTime(this.remaining);
        }
    };
     
     // --- UI MANAGER --- //
     const UI = {
         currentDetailTaskId: null,
         openDetailsModal(taskId, evt = null) {
             if (evt) evt.stopPropagation();
             this.currentDetailTaskId = taskId;
             const task = TaskManager.tasks.find(t => t.id === taskId);
             if (!task) return;
 
             document.getElementById('detailsTitle').textContent = task.title;

            const titleInput = document.getElementById('detailTitleInput');
            const quadrantSelect = document.getElementById('detailQuadrantSelect');
            const timeInput = document.getElementById('detailTimeInput');
            const dueDateInput = document.getElementById('detailDueDateInput');
            const completedCheckbox = document.getElementById('detailCompletedCheckbox');
            const notesArea = document.getElementById('taskNotes');

            if (titleInput) { titleInput.value = task.title; }
            if (quadrantSelect) { quadrantSelect.value = task.quadrant; }
            if (timeInput) { timeInput.value = task.timeBox; }
            if (dueDateInput) {
                dueDateInput.value = task.dueDate ? new Date(task.dueDate).toISOString().split('T')[0] : '';
            }
            if (completedCheckbox) { completedCheckbox.checked = Boolean(task.completed); }
            if (notesArea) { notesArea.value = task.notes || ''; }
             
             const subtasksContainer = document.getElementById('subtasksContainer');
             subtasksContainer.innerHTML = (task.subtasks || []).map(st => `
                 <div class="flex items-center gap-2 p-2 bg-gray-100 rounded-md">
                     <input type="checkbox" ${st.completed ? 'checked' : ''} onchange="TaskManager.toggleSubtask(${st.id})" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
                     <span class="flex-grow ${st.completed ? 'line-through text-gray-500' : 'text-gray-800'}">${st.text}</span>
                     <button onclick="TaskManager.deleteSubtask(${st.id})" class="text-xs text-red-500 hover:text-red-700">Delete</button>
                 </div>
             `).join('') || '<p class="text-sm text-center text-gray-500">No sub-tasks yet.</p>';
             
             const modal = document.getElementById('detailsModal');
             modal.classList.remove('opacity-0', 'pointer-events-none');
             modal.querySelector('.modal-content').classList.remove('scale-95');
 
            if (notesArea) {
                notesArea.onblur = () => TaskManager.updateNotes(notesArea.value);
            }
         },
         closeDetailsModal() {
             this.currentDetailTaskId = null;
             const modal = document.getElementById('detailsModal');
             modal.classList.add('opacity-0');
             modal.querySelector('.modal-content').classList.add('scale-95');
             setTimeout(() => modal.classList.add('pointer-events-none'), 300);
         },
         showNotification(message, type = 'success') {
              const warningDiv = document.getElementById('configWarning');
              warningDiv.innerHTML = message;
              warningDiv.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'bg-green-100', 'text-green-800');
             warningDiv.classList.add(type === 'success' ? 'bg-green-100' : 'bg-red-100', type === 'success' ? 'text-green-800' : 'text-red-800');
              setTimeout(() => {
                 warningDiv.classList.add('hidden');
              }, 5000)
         }
     };
     
     // --- TASK MANAGER --- //
     const TaskManager = {
         tasks: JSON.parse(localStorage.getItem('tasks')) || [],
         idCounter: parseInt(localStorage.getItem('idCounter')) || 1,
         editingTaskId: null,
         init() {
             GEMINI_API_KEY = localStorage.getItem('geminiApiKey') || '';
             this.render();
         },
         addTask(event) {
             event.preventDefault();
             const title = document.getElementById('taskTitle').value.trim();
             const dueDateValue = document.getElementById('taskDueDate').value;
             if (!title) return;
             const task = {
                 id: this.idCounter++, title,
                 timeBox: parseInt(document.getElementById('taskTime').value) || 25,
                 quadrant: parseInt(document.getElementById('taskQuadrant').value),
                 completed: false, createdAt: new Date().toISOString(),
                 dueDate: dueDateValue ? new Date(dueDateValue + 'T00:00:00').toISOString() : null,
                 subtasks: [], notes: ''
             };
             this.tasks.push(task); this.saveAndRender(); event.target.reset();
         },
         editTask(taskId, evt = null) {
             if (evt) evt.stopPropagation();
             this.editingTaskId = taskId;
             this.render();
             if (taskId === null) { return; }
             const input = document.querySelector(`.task-title-input[data-task-id='${taskId}']`);
             if (input) {
                 input.focus();
                 input.select();
             }
         },
         saveTaskTitle(taskId, newTitle) {
             const task = this.tasks.find(t => t.id === taskId);
             if (task && newTitle.trim()) {
                 task.title = newTitle.trim();
             }
             this.editingTaskId = null;
             this.saveAndRender();
         },
         deleteTask(taskId, evt = null) {
             if (evt) evt.stopPropagation();
             if (confirm('Are you sure you want to delete this task?')) { this.tasks = this.tasks.filter(t => t.id !== taskId); this.saveAndRender(); }
         },
        toggleComplete(taskId, evt = null) {
            if (evt) evt.stopPropagation();
            const task = this.tasks.find(t => t.id == taskId);
            if (task) { task.completed = !task.completed; this.saveAndRender(); }
         },
         addSubtask(text, fromAI = false) {
             const taskId = UI.currentDetailTaskId;
             const task = this.tasks.find(t => t.id === taskId);
             let subtaskText = text;
             if (!fromAI) {
                 const input = document.getElementById('newSubtaskInput');
                 subtaskText = input.value.trim();
             }
             if (!task || !subtaskText) return;
             if (!task.subtasks) task.subtasks = [];
             const subtaskId = task.subtasks.length > 0 ? Math.max(...task.subtasks.map(s => s.id)) + 1 : 1;
             task.subtasks.push({ id: subtaskId, text: subtaskText, completed: false });
             if (!fromAI) {
                 document.getElementById('newSubtaskInput').value = '';
             }
             this.saveAndRender();
             UI.openDetailsModal(taskId, null);
         },
        toggleSubtask(subtaskId) {
            const taskId = UI.currentDetailTaskId;
            const task = this.tasks.find(t => t.id === taskId);
            if (!task) return;
            const subtask = task.subtasks.find(st => st.id === subtaskId);
            if (subtask) subtask.completed = !subtask.completed;
            this.saveAndRender();
            UI.openDetailsModal(taskId, null);
        },
         deleteSubtask(subtaskId) {
             const taskId = UI.currentDetailTaskId;
             const task = this.tasks.find(t => t.id === taskId);
             if (!task) return;
             task.subtasks = task.subtasks.filter(st => st.id !== subtaskId);
             this.saveAndRender();
             UI.openDetailsModal(taskId, null);
         },
        updateNotes(notes) {
            const taskId = UI.currentDetailTaskId;
            const task = this.tasks.find(t => t.id === taskId);
            if (task) { task.notes = notes; this.saveAndRender(); }
        },
        saveDetails() {
            const taskId = UI.currentDetailTaskId;
            const task = this.tasks.find(t => t.id === taskId);
            if (!task) { return; }

            const titleInput = document.getElementById('detailTitleInput');
            const quadrantSelect = document.getElementById('detailQuadrantSelect');
            const timeInput = document.getElementById('detailTimeInput');
            const dueDateInput = document.getElementById('detailDueDateInput');
            const completedCheckbox = document.getElementById('detailCompletedCheckbox');

            if (titleInput && titleInput.value.trim()) {
                task.title = titleInput.value.trim();
            }

            if (quadrantSelect) {
                const quadrantValue = parseInt(quadrantSelect.value, 10);
                if (quadrantValue >= 1 && quadrantValue <= 4) {
                    task.quadrant = quadrantValue;
                }
            }

            if (timeInput) {
                const minutes = parseInt(timeInput.value, 10);
                if (!isNaN(minutes) && minutes > 0) {
                    task.timeBox = minutes;
                }
            }

            if (dueDateInput) {
                const dueDateValue = dueDateInput.value;
                task.dueDate = dueDateValue ? new Date(dueDateValue + 'T00:00:00').toISOString() : null;
            }

            if (completedCheckbox) {
                task.completed = completedCheckbox.checked;
            }

            this.saveAndRender();
            UI.openDetailsModal(taskId, null);
            UI.showNotification('Task details updated.', 'success');
        },
        replaceTasks(newTasks) {
            Timer.stop(true);
            this.tasks = newTasks;
            const maxId = this.tasks.reduce((max, task) => Math.max(max, task.id || 0), 0);
            this.idCounter = maxId + 1;
            this.saveAndRender();
        },
         moveTask(taskId, newQuadrant) { const task = this.tasks.find(t => t.id == taskId); if (task) { task.quadrant = newQuadrant; this.saveAndRender(); } },
         dragStart(event, taskId) { 
             event.stopPropagation(); 
             event.dataTransfer.setData('text/plain', taskId);
             event.currentTarget.classList.add('dragging');
         },
         dragEnd(event) {
             event.currentTarget.classList.remove('dragging');
         },
         allowDrop(event) { event.preventDefault(); event.currentTarget.classList.add('drag-over'); },
         dragLeave(event) {
             event.currentTarget.classList.remove('drag-over');
         },
         drop(event) {
             event.preventDefault(); event.currentTarget.classList.remove('drag-over');
             const taskId = event.dataTransfer.getData('text/plain');
             const newQuadrant = parseInt(event.currentTarget.dataset.quadrant);
             this.moveTask(taskId, newQuadrant);
         },
         saveAndRender() { this.checkOverdueTasks(); localStorage.setItem('tasks', JSON.stringify(this.tasks)); localStorage.setItem('idCounter', this.idCounter); this.render(); },
         checkOverdueTasks() {
             const now = new Date();
             this.tasks.forEach(task => { if (task.dueDate && !task.completed) { if (new Date(task.dueDate) < now) { task.quadrant = 1; } } });
         },
                 if (hideCompleted) { quadrantTasks = quadrantTasks.filter(t => !t.completed); }
                 document.getElementById(`count-${i}`).textContent = quadrantTasks.length;
                 if (quadrantTasks.length === 0) { container.innerHTML = `<div class="p-4 text-center text-gray-500">No tasks here.</div>`; continue; }
                 container.innerHTML = quadrantTasks.map(task => {
                     const isRunning = Timer.currentTask && Timer.currentTask.id === task.id;
                     const isOverdue = task.dueDate && !task.completed && new Date(task.dueDate) < new Date();
                     
                     const titleDisplay = this.editingTaskId === task.id
                         ? `<input type="text" class="task-title-input" data-task-id="${task.id}" value="${task.title}"
                                   onblur="TaskManager.saveTaskTitle(${task.id}, this.value)"
                                   onkeydown="if(event.key === 'Enter') this.blur(); if(event.key === 'Escape') TaskManager.editTask(null, event)">`
                         : `<p class="font-semibold text-gray-800 truncate task-title-text" onclick="TaskManager.editTask(${task.id}, event)">${task.title}</p>`;
                     
                     return `
                     <div class="task flex items-center justify-between p-3 transition duration-200 ease-in-out bg-white border-l-4 rounded-lg shadow-sm ${task.completed ? 'completed opacity-60' : ''} ${isRunning ? 'running' : ''} ${isOverdue ? 'overdue' : ''} quadrant-${task.quadrant}-border" 
                          draggable="true" ondragstart="TaskManager.dragStart(event, ${task.id})" ondragend="TaskManager.dragEnd(event)">
                         <div class="flex-1 min-w-0 task-title">
                            ${titleDisplay}
                            <div class="flex items-center gap-3 mt-1 text-xs text-gray-500 task-meta">
                                 ${task.dueDate ? `<span>üìÖ ${new Date(task.dueDate).toLocaleDateString()}</span>` : ''}
                                 <span>‚è±Ô∏è ${task.timeBox}m</span>
                            </div>
                         </div>
                         <div class="flex items-center gap-1 ml-2 task-actions">
                              <button title="Start Timer" onclick="Timer.startFromTask(${task.id}, event)" class="p-1 text-gray-400 rounded-full task-btn hover:bg-gray-200 hover:text-yellow-500">‚è±Ô∏è</button>
                             <button title="Edit Details" onclick="UI.openDetailsModal(${task.id}, event)" class="p-1 text-gray-400 rounded-full task-btn hover:bg-gray-200 hover:text-blue-500">üìù</button>
                             <button title="Mark as ${task.completed ? 'Incomplete' : 'Complete'}" onclick="TaskManager.toggleComplete(${task.id}, event)" class="p-1 text-gray-400 rounded-full task-btn hover:bg-gray-200">${task.completed ? '‚Ü©Ô∏è' : '‚úÖ'}</button>
                             <button title="Delete Task" onclick="TaskManager.deleteTask(${task.id}, event)" class="p-1 text-gray-400 rounded-full task-btn hover:bg-gray-200 hover:text-red-500">üóëÔ∏è</button>
                         </div>
                     </div>
                 `}).join('');
             }
         },
     };
     TaskManager.init();
     </script>
 </body>
 </html>
