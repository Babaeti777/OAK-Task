<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <base target="_top">
    <title>Eisenhower Matrix - AI Task Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
        .quadrant-1-border { border-color: #ef4444 !important; }
        .quadrant-2-border { border-color: #3b82f6 !important; }
        .quadrant-3-border { border-color: #f97316 !important; }
        .quadrant-4-border { border-color: #6b7280 !important; }
        .quadrant-1-text { color: #ef4444 !important; }
        .quadrant-2-text { color: #3b82f6 !important; }
        .quadrant-3-text { color: #f97316 !important; }
        .quadrant-4-text { color: #6b7280 !important; }
        .quadrant-1-bg { background-color: #ef4444 !important; }
        .quadrant-2-bg { background-color: #3b82f6 !important; }
        .quadrant-3-bg { background-color: #f97316 !important; }
        .quadrant-4-bg { background-color: #6b7280 !important; }
        .task.overdue { background-color: #fef2f2; border-left-color: #ef4444; }
        .task.running { box-shadow: 0 0 0 2px #3b82f6; background-color: #dbeafe; }
        .drag-over { transform: scale(1.02); background-color: #eff6ff; }
        .task.dragging { opacity: 0.5; }
        .modal { transition: opacity 0.25s ease; }
        .modal-content { transition: transform 0.25s ease; }
        .task-title-input { width: 100%; padding: 2px; border-radius: 4px; border: 1px solid #cbd5e1; outline: none; font-weight: 600; }
        .task-title-input:focus { border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4); }
        .spinner { border-top-color: #ffffff; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        #timer-fullscreen {
            background: radial-gradient(ellipse at bottom, #1b2735 0%, #090a0f 100%);
            transition: opacity 0.5s ease-in-out;
        }
        #timer-fullscreen-display {
            font-size: clamp(4rem, 25vw, 12rem);
            font-variant-numeric: tabular-nums;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
        }
        .pulse-animation {
            animation: pulse 4s ease-in-out infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.7; }
            50% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); opacity: 0.7; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-200">

    <div id="configWarning" class="hidden px-4 py-3 text-sm font-medium text-center text-red-800 bg-red-100 border-b-2 border-red-200"></div>
    
    <div id="main-content">
        <div class="min-h-screen p-4 mx-auto max-w-7xl sm:p-6 lg:p-8">
            <header class="mb-8 text-center">
                <h1 class="text-4xl font-bold tracking-tight text-gray-800 sm:text-5xl">Eisenhower Matrix</h1>
                <p class="mt-2 text-lg text-gray-600">AI-Powered Task Management.</p>
                <p class="mt-4 text-sm text-gray-500">Manage your tasks, edit details inline, and keep everything in sync with Excel exports.</p>
            </header>
            <div class="grid grid-cols-1 gap-6 mb-8 lg:grid-cols-3">
                <div class="p-6 bg-white border border-gray-200 rounded-2xl shadow-lg lg:col-span-2">
                    <h2 class="text-lg font-semibold text-gray-800">Add a New Task</h2>
                     <form id="addTaskForm" class="mt-4" onsubmit="TaskManager.addTask(event)">
                        <div class="mb-4">
                            <label for="taskTitle" class="text-sm font-medium text-gray-600">Task Title</label>
                            <input type="text" id="taskTitle" placeholder="e.g., Finish project proposal" class="w-full px-4 py-2 mt-1 text-gray-800 bg-gray-100 border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <div class="grid grid-cols-1 gap-4 sm:grid-cols-3">
                            <div>
                                <label for="taskQuadrant" class="text-sm font-medium text-gray-600">Priority</label>
                                <select id="taskQuadrant" class="w-full px-4 py-2 mt-1 text-gray-800 bg-gray-100 border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                    <option value="1">üî• Urgent & Important</option>
                                    <option value="2" selected>üìÖ Important</option>
                                    <option value="3">‚ö° Urgent</option>
                                    <option value="4">üóëÔ∏è Eliminate</option>
                                </select>
                            </div>
                            <div>
                                <label for="taskTime" class="text-sm font-medium text-gray-600">Est. Minutes</label>
                                <input type="number" id="taskTime" value="25" min="5" class="w-full px-4 py-2 mt-1 text-gray-800 bg-gray-100 border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="taskDueDate" class="text-sm font-medium text-gray-600">Due Date</label>
                                <input type="date" id="taskDueDate" class="w-full px-4 py-2 mt-1 text-gray-800 bg-gray-100 border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                        <button type="submit" class="w-full px-6 py-3 mt-6 font-semibold text-white bg-blue-600 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Add Task</button>
                    </form>
                </div>
                <div class="p-6 bg-white border border-gray-200 rounded-2xl shadow-lg">
                     <h2 class="text-lg font-semibold text-gray-800">Options</h2>
                     <div class="mt-4 space-y-4">
                         <label class="flex items-center justify-between p-4 bg-gray-100 rounded-lg cursor-pointer">
                            <span class="font-medium text-gray-700">Hide Completed Tasks</span>
                            <div class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="hideCompleted" class="sr-only peer" onchange="TaskManager.render()">
                                <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-4 peer-focus:ring-blue-300 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </div>
                        </label>
                        <div class="p-4 bg-gray-100 rounded-lg">
                            <div class="flex items-start justify-between gap-4">
                                <div>
                                    <p class="font-semibold text-gray-700">OneDrive Sync</p>
                                    <p id="oneDriveStatus" class="mt-1 text-sm text-gray-600">Not connected.</p>
                                </div>
                                <div class="flex flex-col items-stretch gap-2 min-w-[140px]">
                                    <button id="oneDriveSignInBtn" onclick="OneDriveService.signIn()" class="px-3 py-2 text-sm font-semibold text-white bg-blue-600 rounded-md hover:bg-blue-700">Sign in</button>
                                    <button id="oneDriveSignOutBtn" onclick="OneDriveService.signOut()" class="hidden px-3 py-2 text-sm font-semibold text-blue-700 bg-blue-100 rounded-md hover:bg-blue-200">Sign out</button>
                                </div>
                            </div>
                            <p class="mt-3 text-xs text-gray-500">Changes are saved automatically to OneDrive after you connect.</p>
                        </div>
                     </div>
                </div>
            </div>
            <main class="grid grid-cols-1 gap-6 md:grid-cols-2 lg:gap-8">
                <div class="quadrant quadrant-1 bg-white border-t-4 border-gray-200 rounded-2xl shadow-lg" data-quadrant="1" ondrop="TaskManager.drop(event)" ondragover="TaskManager.allowDrop(event)" ondragleave="TaskManager.dragLeave(event)">
                    <div class="flex items-center justify-between p-4 border-b border-gray-200"><h3 class="text-lg font-bold quadrant-1-text">üî• Urgent & Important (Do)</h3><div id="count-1" class="px-3 py-1 text-sm font-bold text-white rounded-full quadrant-1-bg">0</div></div><div id="tasks-1" class="p-4 space-y-3"></div>
                </div>
                <div class="quadrant quadrant-2 bg-white border-t-4 border-gray-200 rounded-2xl shadow-lg" data-quadrant="2" ondrop="TaskManager.drop(event)" ondragover="TaskManager.allowDrop(event)" ondragleave="TaskManager.dragLeave(event)">
                    <div class="flex items-center justify-between p-4 border-b border-gray-200"><h3 class="text-lg font-bold quadrant-2-text">üìÖ Important (Schedule)</h3><div id="count-2" class="px-3 py-1 text-sm font-bold text-white rounded-full quadrant-2-bg">0</div></div><div id="tasks-2" class="p-4 space-y-3"></div>
                </div>
                <div class="quadrant quadrant-3 bg-white border-t-4 border-gray-200 rounded-2xl shadow-lg" data-quadrant="3" ondrop="TaskManager.drop(event)" ondragover="TaskManager.allowDrop(event)" ondragleave="TaskManager.dragLeave(event)">
                    <div class="flex items-center justify-between p-4 border-b border-gray-200"><h3 class="text-lg font-bold quadrant-3-text">‚ö° Urgent (Delegate)</h3><div id="count-3" class="px-3 py-1 text-sm font-bold text-white rounded-full quadrant-3-bg">0</div></div><div id="tasks-3" class="p-4 space-y-3"></div>
                </div>
                <div class="quadrant quadrant-4 bg-white border-t-4 border-gray-200 rounded-2xl shadow-lg" data-quadrant="4" ondrop="TaskManager.drop(event)" ondragover="TaskManager.allowDrop(event)" ondragleave="TaskManager.dragLeave(event)">
                    <div class="flex items-center justify-between p-4 border-b border-gray-200"><h3 class="text-lg font-bold quadrant-4-text">üóëÔ∏è Neither (Eliminate)</h3><div id="count-4" class="px-3 py-1 text-sm font-bold text-white rounded-full quadrant-4-bg">0</div></div><div id="tasks-4" class="p-4 space-y-3"></div>
                </div>
            </main>
        </div>
    </div>

    <!-- Timer Fullscreen Overlay -->
    <div id="timer-fullscreen" class="fixed inset-0 z-50 flex-col items-center justify-center hidden text-white opacity-0">
        <div class="text-center pulse-animation">
            <h2 id="timer-fullscreen-task-title" class="mb-4 text-4xl font-semibold opacity-80"></h2>
            <div id="timer-fullscreen-display" class="font-bold">25:00</div>
        </div>
        <div class="absolute flex gap-4 bottom-10">
            <button id="timer-fullscreen-pause" onclick="Timer.pause()" class="px-6 py-3 font-semibold text-white bg-white bg-opacity-20 rounded-lg hover:bg-opacity-30">Pause</button>
            <button id="timer-fullscreen-start" onclick="Timer.start()" class="hidden px-6 py-3 font-semibold text-white bg-white bg-opacity-20 rounded-lg hover:bg-opacity-30">Resume</button>
            <button onclick="Timer.stop()" class="px-6 py-3 font-semibold text-white bg-red-500 rounded-lg hover:bg-red-600">Stop & Exit</button>
        </div>
    </div>


    <div id="detailsModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 transition-opacity duration-300 bg-black bg-opacity-50 opacity-0 pointer-events-none modal">
        <div class="w-full max-w-lg p-6 bg-white modal-content rounded-2xl shadow-2xl scale-95 transform-gpu transition-transform duration-300">
            <div class="flex items-center justify-between pb-3 border-b border-gray-200">
                <h3 id="detailsTitle" class="text-2xl font-bold text-gray-800">Task Details</h3>
                <button onclick="UI.closeDetailsModal()" class="p-1 text-gray-400 rounded-full hover:bg-gray-200 hover:text-gray-600">&times;</button>
            </div>
            <div class="mt-4 space-y-6">
                <div class="space-y-4">
                    <div>
                        <label for="detailTitleInput" class="text-sm font-medium text-gray-600">Task Title</label>
                        <input id="detailTitleInput" type="text" class="w-full px-3 py-2 mt-1 bg-gray-100 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="Update the task title">
                    </div>
                    <div class="grid grid-cols-1 gap-4 sm:grid-cols-3">
                        <div>
                            <label for="detailQuadrantSelect" class="text-sm font-medium text-gray-600">Priority</label>
                            <select id="detailQuadrantSelect" class="w-full px-3 py-2 mt-1 bg-gray-100 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                                <option value="1">üî• Urgent & Important</option>
                                <option value="2">üìÖ Important</option>
                                <option value="3">‚ö° Urgent</option>
                                <option value="4">üóëÔ∏è Eliminate</option>
                            </select>
                        </div>
                        <div>
                            <label for="detailTimeInput" class="text-sm font-medium text-gray-600">Est. Minutes</label>
                            <input id="detailTimeInput" type="number" min="5" class="w-full px-3 py-2 mt-1 bg-gray-100 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="detailDueDateInput" class="text-sm font-medium text-gray-600">Due Date</label>
                            <input id="detailDueDateInput" type="date" class="w-full px-3 py-2 mt-1 bg-gray-100 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    <label class="inline-flex items-center gap-2 text-sm font-medium text-gray-600">
                        <input id="detailCompletedCheckbox" type="checkbox" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
                        Mark as completed
                    </label>
                    <div class="flex justify-end">
                        <button onclick="TaskManager.saveDetails()" class="flex items-center gap-2 px-4 py-2 text-sm font-semibold text-white bg-blue-600 rounded-md shadow hover:bg-blue-700">
                            <span>üíæ Save Changes</span>
                        </button>
                    </div>
                </div>
                <div class="pt-4 border-t border-gray-200">
                    <div class="flex items-center justify-between">
                        <h4 class="font-semibold text-gray-700">Sub-tasks</h4>
                        <button id="generateSubtasksBtn" onclick="GeminiService.generateSubtasks()" class="flex items-center gap-1 px-2 py-1 text-xs font-semibold text-white bg-purple-500 rounded-md hover:bg-purple-600">
                            <span class="btn-text">‚ú® Smart Sub-tasks</span>
                            <div class="hidden w-4 h-4 border-2 border-t-transparent border-white rounded-full spinner"></div>
                        </button>
                    </div>
                    <div id="subtasksContainer" class="mt-2 space-y-2"></div>
                    <div class="flex gap-2 mt-2">
                        <input type="text" id="newSubtaskInput" placeholder="Add a new sub-task..." class="flex-grow px-3 py-1 bg-gray-100 border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        <button onclick="TaskManager.addSubtask()" class="px-3 py-1 font-semibold text-white bg-blue-500 rounded-md hover:bg-blue-600">Add</button>
                    </div>
                </div>
                <div class="pt-4 border-t border-gray-200">
                     <div class="flex items-center justify-between">
                        <h4 class="font-semibold text-gray-700">Notes</h4>
                        <button id="generateNotesBtn" onclick="GeminiService.generateNotes()" class="flex items-center gap-1 px-2 py-1 text-xs font-semibold text-white bg-purple-500 rounded-md hover:bg-purple-600">
                             <span class="btn-text">‚ú® Generate Notes</span>
                             <div class="hidden w-4 h-4 border-2 border-t-transparent border-white rounded-full spinner"></div>
                        </button>
                    </div>
                    <textarea id="taskNotes" rows="4" class="w-full p-2 mt-2 bg-gray-100 border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="Add any notes here..."></textarea>
                </div>
            </div>
             <div class="flex justify-end mt-6">
                <button onclick="UI.closeDetailsModal()" class="px-6 py-2 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">Close</button>
            </div>
        </div>
    </div>
    
    <script src="https://alcdn.msauth.net/browser/2.37.0/js/msal-browser.min.js" integrity="sha384-p+NQGQ9dI4QmqC6cKUu9Bj83oX6TA8XyqRLrX9Zjrs8ZgM9MJ3ZOjcRQtFoLSI93" crossorigin="anonymous"></script>

    <script>
    // --- CONFIGURATION --- //
    let GEMINI_API_KEY = "";
    const ONEDRIVE_CONFIG = {
        // Set this to your Microsoft Entra application (client) ID before enabling sync.
        clientId: "",
        tenantId: "common",
        filePath: "/Documents/EisenhowerTasks.json"
    };

    const GEMINI_MODEL = "gemini-1.5-flash-latest";
    
    // --- GEMINI AI SERVICE --- //
    const GeminiService = {
        setLoadingState(buttonId, isLoading) {
            const button = document.getElementById(buttonId);
            if (button) {
                const text = button.querySelector('.btn-text');
                const spinner = button.querySelector('.spinner');
                if (isLoading) {
                    text.classList.add('hidden');
                    spinner.classList.remove('hidden');
                    button.disabled = true;
                } else {
                    text.classList.remove('hidden');
                    spinner.classList.add('hidden');
                    button.disabled = false;
                }
            }
        },
        async call(promptText) {
            if (!GEMINI_API_KEY) {
                const key = window.prompt("Please enter your Gemini API Key. You can get one from Google AI Studio.");
                if (key) {
                    GEMINI_API_KEY = key;
                    if (typeof sessionStorage !== 'undefined') {
                        sessionStorage.setItem('geminiApiKey', key);
                    }
                } else {
                    UI.showNotification("Gemini API Key is required for this feature.", "error");
                    return null;
                }
            }
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`;
            const payload = { contents: [{ role: "user", parts: [{ text: promptText }] }] };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    throw new Error(`API call failed with status: ${response.status}`);
                }
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0) {
                    return result.candidates[0].content.parts[0].text;
                }
                return null;
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                UI.showNotification("Failed to call Gemini API. Check console for details.", "error");
                return null;
            }
        },
        async generateSubtasks() {
            this.setLoadingState('generateSubtasksBtn', true);
            const task = TaskManager.tasks.find(t => t.id === UI.currentDetailTaskId);
            if (!task) { this.setLoadingState('generateSubtasksBtn', false); return; }

            const promptText = `Based on the main task "${task.title}", generate a list of 3 to 5 actionable sub-tasks. The sub-tasks should be concise and clear. Return them as a simple comma-separated list. For example: "Sub-task one,Sub-task two,Sub-task three"`;
            const result = await this.call(promptText);
            if (result) {
                result.split(',').forEach(subtaskText => {
                    if (subtaskText.trim()) {
                        TaskManager.addSubtask(subtaskText.trim(), true);
                    }
                });
            }
            this.setLoadingState('generateSubtasksBtn', false);
        },
        async generateNotes() {
            this.setLoadingState('generateNotesBtn', true);
            const task = TaskManager.tasks.find(t => t.id === UI.currentDetailTaskId);
            if (!task) { this.setLoadingState('generateNotesBtn', false); return; }

            const promptText = `Generate helpful notes for the task: "${task.title}". The notes should be a short paragraph, offering a brief plan or key considerations.`;
            const result = await this.call(promptText);
            if (result) {
                const notesArea = document.getElementById('taskNotes');
                notesArea.value = result;
                TaskManager.updateNotes(result);
            }
            this.setLoadingState('generateNotesBtn', false);
        }
    };

    // --- ONEDRIVE SYNC SERVICE --- //
    const OneDriveService = {
        msalInstance: null,
        account: null,
        statusElement: null,
        signInButton: null,
        signOutButton: null,
        autoSaveTimer: null,
        pendingPayload: null,
        suppressNextSave: false,
        configured: Boolean(ONEDRIVE_CONFIG.clientId),
        init() {
            this.configured = Boolean(ONEDRIVE_CONFIG.clientId);
            this.statusElement = document.getElementById('oneDriveStatus');
            this.signInButton = document.getElementById('oneDriveSignInBtn');
            this.signOutButton = document.getElementById('oneDriveSignOutBtn');

            if (!this.statusElement) {
                return;
            }

            if (!this.configured) {
                this.setStatus('OneDrive sync is not configured. Add your Microsoft app Client ID in ONEDRIVE_CONFIG.', 'error');
                this.updateButtons(false, true);
                return;
            }

            if (typeof msal === 'undefined') {
                this.setStatus('Microsoft authentication library could not be loaded.', 'error');
                this.updateButtons(false);
                return;
            }

            this.msalInstance = new msal.PublicClientApplication({
                auth: {
                    clientId: ONEDRIVE_CONFIG.clientId,
                    authority: `https://login.microsoftonline.com/${ONEDRIVE_CONFIG.tenantId}`,
                    redirectUri: window.location.origin + window.location.pathname
                },
                cache: { cacheLocation: 'localStorage', storeAuthStateInCookie: false }
            });

            this.updateButtons(false);
            this.setStatus('Sign in to sync with OneDrive.', 'default');

            this.msalInstance.handleRedirectPromise()
                .then((response) => {
                    if (response && response.account) {
                        this.account = response.account;
                    } else {
                        const accounts = this.msalInstance.getAllAccounts();
                        if (accounts.length > 0) {
                            this.account = accounts[0];
                        }
                    }

                    if (this.account) {
                        this.msalInstance.setActiveAccount(this.account);
                        this.updateButtons(true);
                        this.setStatus(`Connected as ${this.account.username}`, 'success');
                        this.loadTasks();
                    }
                })
                .catch((error) => {
                    console.error('OneDrive initialization error:', error);
                    this.setStatus('Failed to initialize OneDrive sync.', 'error');
                });
        },
        setStatus(message, intent = 'default') {
            if (!this.statusElement) return;
            this.statusElement.textContent = message;
            this.statusElement.classList.remove('text-gray-600', 'text-green-600', 'text-red-600');
            const intentClass = intent === 'success' ? 'text-green-600' : intent === 'error' ? 'text-red-600' : 'text-gray-600';
            this.statusElement.classList.add(intentClass);
        },
        updateButtons(isSignedIn, disableSignIn = false) {
            if (this.signInButton) {
                this.signInButton.classList.toggle('hidden', isSignedIn || disableSignIn);
                this.signInButton.disabled = disableSignIn;
            }
            if (this.signOutButton) {
                this.signOutButton.classList.toggle('hidden', !isSignedIn);
            }
        },
        isReady() {
            return this.configured && this.msalInstance && this.account;
        },
        getContentUrl() {
            const path = ONEDRIVE_CONFIG.filePath.startsWith('/') ? ONEDRIVE_CONFIG.filePath : `/${ONEDRIVE_CONFIG.filePath}`;
            return `https://graph.microsoft.com/v1.0/me/drive/root:${encodeURI(path)}:/content`;
        },
        async signIn() {
            if (!this.msalInstance) {
                this.init();
                if (!this.msalInstance) return;
            }
            try {
                const response = await this.msalInstance.loginPopup({ scopes: ['Files.ReadWrite.All'] });
                if (response && response.account) {
                    this.account = response.account;
                    this.msalInstance.setActiveAccount(this.account);
                    this.updateButtons(true);
                    this.setStatus(`Connected as ${this.account.username}`, 'success');
                    await this.loadTasks();
                }
            } catch (error) {
                if (error && (error.errorCode === 'user_cancelled' || error.errorCode === 'user_cancelled_login')) {
                    this.setStatus('Sign-in was cancelled.', 'error');
                } else {
                    console.error('OneDrive sign-in error:', error);
                    this.setStatus('Failed to sign in to OneDrive.', 'error');
                }
            }
        },
        async signOut() {
            if (!this.msalInstance || !this.account) return;
            try {
                await this.msalInstance.logoutPopup({ account: this.account });
            } catch (error) {
                console.error('OneDrive sign-out error:', error);
            }
            this.account = null;
            if (this.autoSaveTimer) {
                clearTimeout(this.autoSaveTimer);
                this.autoSaveTimer = null;
            }
            this.pendingPayload = null;
            this.updateButtons(false);
            this.setStatus('Sign in to sync with OneDrive.', 'default');
        },
        async acquireToken() {
            if (!this.isReady()) {
                throw new Error('Not authenticated with OneDrive.');
            }
            try {
                return await this.msalInstance.acquireTokenSilent({
                    scopes: ['Files.ReadWrite.All'],
                    account: this.account
                });
            } catch (error) {
                if (typeof msal !== 'undefined' && error instanceof msal.InteractionRequiredAuthError) {
                    return this.msalInstance.acquireTokenPopup({ scopes: ['Files.ReadWrite.All'] });
                }
                throw error;
            }
        },
        async loadTasks() {
            if (!this.isReady()) return;
            try {
                this.setStatus('Syncing with OneDrive‚Ä¶', 'default');
                const tokenResponse = await this.acquireToken();
                const response = await fetch(this.getContentUrl(), {
                    headers: { Authorization: `Bearer ${tokenResponse.accessToken}` }
                });
                if (response.status === 404) {
                    this.setStatus('A new OneDrive task file will be created on your next change.', 'default');
                    return;
                }
                if (!response.ok) {
                    throw new Error(`Unexpected status ${response.status}`);
                }
                const text = await response.text();
                let data = [];
                if (text) {
                    try {
                        data = JSON.parse(text);
                    } catch (parseError) {
                        throw new Error('Unable to parse OneDrive task data.');
                    }
                }
                if (Array.isArray(data)) {
                    this.suppressNextSave = true;
                    TaskManager.replaceTasks(data);
                    this.setStatus('Tasks synced from OneDrive.', 'success');
                } else {
                    throw new Error('Unexpected data format.');
                }
            } catch (error) {
                console.error('OneDrive load error:', error);
                this.setStatus('Failed to load tasks from OneDrive.', 'error');
            }
        },
        queueSave(tasks) {
            if (!this.isReady()) return;
            if (this.suppressNextSave) {
                this.suppressNextSave = false;
                return;
            }
            this.pendingPayload = JSON.stringify(tasks);
            if (this.autoSaveTimer) {
                clearTimeout(this.autoSaveTimer);
            }
            this.autoSaveTimer = setTimeout(() => {
                const payload = this.pendingPayload;
                this.pendingPayload = null;
                this.saveTasks(payload);
            }, 1500);
            this.setStatus('Pending changes‚Ä¶', 'default');
        },
        async saveTasks(payload) {
            if (!this.isReady() || !payload) return;
            try {
                this.setStatus('Saving changes to OneDrive‚Ä¶', 'default');
                const tokenResponse = await this.acquireToken();
                const response = await fetch(this.getContentUrl(), {
                    method: 'PUT',
                    headers: {
                        Authorization: `Bearer ${tokenResponse.accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: payload
                });
                if (!response.ok) {
                    throw new Error(`Unexpected status ${response.status}`);
                }
                this.setStatus('All changes saved to OneDrive.', 'success');
            } catch (error) {
                console.error('OneDrive save error:', error);
                this.setStatus('Failed to save changes to OneDrive.', 'error');
            }
        }
    };
    
    // --- TIMER --- //
    const Timer = {
        currentTask: null, duration: 0, remaining: 0, interval: null, isRunning: false,
        startFromTask(taskId, evt = null) {
            if (evt) evt.stopPropagation();
            const task = TaskManager.tasks.find(t => t.id === taskId);
            if (!task) return;
            
            if (this.currentTask && this.currentTask.id === taskId) {
                // If clicking the same task, toggle play/pause
                this.isRunning ? this.pause() : this.start();
            } else {
                 // If a different timer is running, stop it first
                if (this.isRunning) {
                    this.stop(true); // stop without rendering
                }
                // Start a new timer
                this.currentTask = task;
                this.duration = task.timeBox * 60;
                this.remaining = task.remainingTime || this.duration;
                this.showFullscreen();
                this.start();
            }
        },
        start() {
            if (this.isRunning || !this.currentTask) return;
            this.isRunning = true;
            document.getElementById('timer-fullscreen-pause').classList.remove('hidden');
            document.getElementById('timer-fullscreen-start').classList.add('hidden');
            this.updateFullscreenDisplay();
            this.interval = setInterval(this.tick.bind(this), 1000);
            TaskManager.render();
        },
        tick() {
            this.remaining--;
            this.currentTask.remainingTime = this.remaining;
            this.updateFullscreenDisplay();
            if (this.remaining < 0) { this.complete(); }
        },
        pause() {
            if (!this.isRunning) return;
            this.isRunning = false; clearInterval(this.interval);
            document.getElementById('timer-fullscreen-pause').classList.add('hidden');
            document.getElementById('timer-fullscreen-start').classList.remove('hidden');
            TaskManager.saveAndRender();
        },
        stop(isSwitching = false) {
            if(this.currentTask) {
                delete this.currentTask.remainingTime;
                this.isRunning = false;
                clearInterval(this.interval);
                this.closeFullscreen();
                this.currentTask = null;
                if (!isSwitching) TaskManager.saveAndRender();
            }
        },
        complete() { UI.showNotification(`Timer for "${this.currentTask.title}" complete!`, 'success'); this.stop(); },
        showFullscreen() {
            document.getElementById('timer-fullscreen-task-title').textContent = this.currentTask.title;
            const timerScreen = document.getElementById('timer-fullscreen');
            timerScreen.classList.remove('hidden');
            setTimeout(() => timerScreen.classList.remove('opacity-0'), 10);
            document.getElementById('main-content').classList.add('hidden');
        },
        closeFullscreen() {
             const timerScreen = document.getElementById('timer-fullscreen');
             timerScreen.classList.add('opacity-0');
             setTimeout(() => timerScreen.classList.add('hidden'), 500);
             document.getElementById('main-content').classList.remove('hidden');
        },
        updateFullscreenDisplay() {
            const formatTime = (seconds) => {
                if (seconds < 0) seconds = 0;
                const m = Math.floor(seconds / 60); const s = seconds % 60;
                return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            };
            document.getElementById('timer-fullscreen-display').textContent = formatTime(this.remaining);
        }
    };
    
    // --- UI MANAGER --- //
    const UI = {
        currentDetailTaskId: null,
        openDetailsModal(taskId, evt = null) {
            if (evt) evt.stopPropagation();
            this.currentDetailTaskId = taskId;
            const task = TaskManager.tasks.find(t => t.id === taskId);
            if (!task) return;

            document.getElementById('detailsTitle').textContent = task.title;

            const titleInput = document.getElementById('detailTitleInput');
            const quadrantSelect = document.getElementById('detailQuadrantSelect');
            const timeInput = document.getElementById('detailTimeInput');
            const dueDateInput = document.getElementById('detailDueDateInput');
            const completedCheckbox = document.getElementById('detailCompletedCheckbox');
            const notesArea = document.getElementById('taskNotes');

            if (titleInput) { titleInput.value = task.title; }
            if (quadrantSelect) { quadrantSelect.value = task.quadrant; }
            if (timeInput) { timeInput.value = task.timeBox; }
            if (dueDateInput) {
                dueDateInput.value = task.dueDate ? new Date(task.dueDate).toISOString().split('T')[0] : '';
            }
            if (completedCheckbox) { completedCheckbox.checked = Boolean(task.completed); }
            if (notesArea) { notesArea.value = task.notes || ''; }
            
            const subtasksContainer = document.getElementById('subtasksContainer');
            subtasksContainer.textContent = '';
            const subtasks = task.subtasks || [];
            if (subtasks.length === 0) {
                const emptyMessage = document.createElement('p');
                emptyMessage.className = 'text-sm text-center text-gray-500';
                emptyMessage.textContent = 'No sub-tasks yet.';
                subtasksContainer.appendChild(emptyMessage);
            } else {
                const fragment = document.createDocumentFragment();
                subtasks.forEach((st) => {
                    const subtaskRow = document.createElement('div');
                    subtaskRow.className = 'flex items-center gap-2 p-2 bg-gray-100 rounded-md';

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.checked = Boolean(st.completed);
                    checkbox.className = 'w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500';
                    checkbox.addEventListener('change', () => TaskManager.toggleSubtask(st.id));

                    const textSpan = document.createElement('span');
                    textSpan.className = `flex-grow ${st.completed ? 'line-through text-gray-500' : 'text-gray-800'}`;
                    textSpan.textContent = st.text;

                    const deleteButton = document.createElement('button');
                    deleteButton.className = 'text-xs text-red-500 hover:text-red-700';
                    deleteButton.textContent = 'Delete';
                    deleteButton.addEventListener('click', () => TaskManager.deleteSubtask(st.id));

                    subtaskRow.append(checkbox, textSpan, deleteButton);
                    fragment.appendChild(subtaskRow);
                });
                subtasksContainer.appendChild(fragment);
            }
            
            const modal = document.getElementById('detailsModal');
            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.querySelector('.modal-content').classList.remove('scale-95');

            if (notesArea) {
                notesArea.onblur = () => TaskManager.updateNotes(notesArea.value);
            }
        },
        closeDetailsModal() {
            this.currentDetailTaskId = null;
            const modal = document.getElementById('detailsModal');
            modal.classList.add('opacity-0');
            modal.querySelector('.modal-content').classList.add('scale-95');
            setTimeout(() => modal.classList.add('pointer-events-none'), 300);
        },
        showNotification(message, type = 'success') {
             const warningDiv = document.getElementById('configWarning');
             warningDiv.textContent = message;
             warningDiv.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'bg-green-100', 'text-green-800');
             warningDiv.classList.add(type === 'success' ? 'bg-green-100' : 'bg-red-100', type === 'success' ? 'text-green-800' : 'text-red-800');
             setTimeout(() => {
                warningDiv.classList.add('hidden');
             }, 5000)
        }
    };
    
    // --- TASK MANAGER --- //
    const TaskManager = {
        tasks: [],
        idCounter: 1,
        editingTaskId: null,
        init() {
            if (typeof localStorage !== 'undefined' && localStorage.getItem('geminiApiKey')) {
                localStorage.removeItem('geminiApiKey');
            }
            if (typeof sessionStorage !== 'undefined') {
                GEMINI_API_KEY = sessionStorage.getItem('geminiApiKey') || '';
            }
            this.render();
            OneDriveService.init();
        },
        addTask(event) {
            event.preventDefault();
            const title = document.getElementById('taskTitle').value.trim();
            const dueDateValue = document.getElementById('taskDueDate').value;
            if (!title) return;
            const task = {
                id: this.idCounter++, title,
                timeBox: parseInt(document.getElementById('taskTime').value) || 25,
                quadrant: parseInt(document.getElementById('taskQuadrant').value),
                completed: false, createdAt: new Date().toISOString(),
                dueDate: dueDateValue ? new Date(dueDateValue + 'T00:00:00').toISOString() : null,
                subtasks: [], notes: ''
            };
            this.tasks.push(task); this.saveAndRender(); event.target.reset();
        },
        editTask(taskId, evt = null) {
            if (evt) evt.stopPropagation();
            this.editingTaskId = taskId;
            this.render();
            if (taskId === null) { return; }
            const input = document.querySelector(`.task-title-input[data-task-id='${taskId}']`);
            if (input) {
                input.focus();
                input.select();
            }
        },
        saveTaskTitle(taskId, newTitle) {
            const task = this.tasks.find(t => t.id === taskId);
            if (task && newTitle.trim()) {
                task.title = newTitle.trim();
            }
            this.editingTaskId = null;
            this.saveAndRender();
        },
        deleteTask(taskId, evt = null) {
            if (evt) evt.stopPropagation();
            if (confirm('Are you sure you want to delete this task?')) { this.tasks = this.tasks.filter(t => t.id !== taskId); this.saveAndRender(); }
        },
        toggleComplete(taskId, evt = null) {
            if (evt) evt.stopPropagation();
            const task = this.tasks.find(t => t.id == taskId);
            if(task) { task.completed = !task.completed; this.saveAndRender(); }
        },
        addSubtask(text, fromAI = false) {
            const taskId = UI.currentDetailTaskId;
            const task = this.tasks.find(t => t.id === taskId);
            let subtaskText = text;
            if (!fromAI) {
                const input = document.getElementById('newSubtaskInput');
                subtaskText = input.value.trim();
            }
            if (!task || !subtaskText) return;
            if (!task.subtasks) task.subtasks = [];
            const subtaskId = task.subtasks.length > 0 ? Math.max(...task.subtasks.map(s => s.id)) + 1 : 1;
            task.subtasks.push({ id: subtaskId, text: subtaskText, completed: false });
            if (!fromAI) {
                document.getElementById('newSubtaskInput').value = '';
            }
            this.saveAndRender();
            UI.openDetailsModal(taskId, null);
        },
        toggleSubtask(subtaskId) {
            const taskId = UI.currentDetailTaskId;
            const task = this.tasks.find(t => t.id === taskId);
            if (!task) return;
            const subtask = task.subtasks.find(st => st.id === subtaskId);
            if(subtask) subtask.completed = !subtask.completed;
            this.saveAndRender();
            UI.openDetailsModal(taskId, null);
        },
        deleteSubtask(subtaskId) {
            const taskId = UI.currentDetailTaskId;
            const task = this.tasks.find(t => t.id === taskId);
            if (!task) return;
            task.subtasks = task.subtasks.filter(st => st.id !== subtaskId);
            this.saveAndRender();
            UI.openDetailsModal(taskId, null);
        },
        updateNotes(notes) {
            const taskId = UI.currentDetailTaskId;
            const task = this.tasks.find(t => t.id === taskId);
            if (task) { task.notes = notes; this.saveAndRender(); }
        },
        saveDetails() {
            const taskId = UI.currentDetailTaskId;
            const task = this.tasks.find(t => t.id === taskId);
            if (!task) { return; }

            const titleInput = document.getElementById('detailTitleInput');
            const quadrantSelect = document.getElementById('detailQuadrantSelect');
            const timeInput = document.getElementById('detailTimeInput');
            const dueDateInput = document.getElementById('detailDueDateInput');
            const completedCheckbox = document.getElementById('detailCompletedCheckbox');

            if (titleInput && titleInput.value.trim()) {
                task.title = titleInput.value.trim();
            }

            if (quadrantSelect) {
                const quadrantValue = parseInt(quadrantSelect.value, 10);
                if (quadrantValue >= 1 && quadrantValue <= 4) {
                    task.quadrant = quadrantValue;
                }
            }

            if (timeInput) {
                const minutes = parseInt(timeInput.value, 10);
                if (!isNaN(minutes) && minutes > 0) {
                    task.timeBox = minutes;
                }
            }

            if (dueDateInput) {
                const dueDateValue = dueDateInput.value;
                task.dueDate = dueDateValue ? new Date(dueDateValue + 'T00:00:00').toISOString() : null;
            }

            if (completedCheckbox) {
                task.completed = completedCheckbox.checked;
            }

            this.saveAndRender();
            UI.openDetailsModal(taskId, null);
            UI.showNotification('Task details updated.', 'success');
        },
        replaceTasks(newTasks) {
            this.tasks = newTasks;
            const maxId = this.tasks.reduce((max, task) => Math.max(max, task.id || 0), 0);
            this.idCounter = maxId + 1;
            this.saveAndRender();
        },
        moveTask(taskId, newQuadrant) { const task = this.tasks.find(t => t.id == taskId); if (task) { task.quadrant = newQuadrant; this.saveAndRender(); } },
        dragStart(event, taskId) { 
            event.stopPropagation(); 
            event.dataTransfer.setData('text/plain', taskId);
            event.currentTarget.classList.add('dragging');
        },
        dragEnd(event) {
            event.currentTarget.classList.remove('dragging');
        },
        allowDrop(event) { event.preventDefault(); event.currentTarget.classList.add('drag-over'); },
        dragLeave(event) {
            event.currentTarget.classList.remove('drag-over');
        },
        drop(event) {
            event.preventDefault(); event.currentTarget.classList.remove('drag-over');
            const taskId = event.dataTransfer.getData('text/plain');
            const newQuadrant = parseInt(event.currentTarget.dataset.quadrant);
            this.moveTask(taskId, newQuadrant);
        },
        saveAndRender() {
            this.checkOverdueTasks();
            localStorage.setItem('tasks', JSON.stringify(this.tasks));
            localStorage.setItem('idCounter', this.idCounter);
            this.render();
            OneDriveService.queueSave(this.tasks);
        },
        checkOverdueTasks() {
            const now = new Date();
            this.tasks.forEach(task => { if (task.dueDate && !task.completed) { if (new Date(task.dueDate) < now) { task.quadrant = 1; } } });
        },
        render() {
            const hideCompleted = document.getElementById('hideCompleted').checked;
            for (let i = 1; i <= 4; i++) {
                const container = document.getElementById(`tasks-${i}`);
                let quadrantTasks = this.tasks.filter(t => t.quadrant == i);
                if (hideCompleted) { quadrantTasks = quadrantTasks.filter(t => !t.completed); }
                document.getElementById(`count-${i}`).textContent = quadrantTasks.length;
                if (quadrantTasks.length === 0) {
                    container.textContent = '';
                    const empty = document.createElement('div');
                    empty.className = 'p-4 text-center text-gray-500';
                    empty.textContent = 'No tasks here.';
                    container.appendChild(empty);
                    continue;
                }

                container.textContent = '';
                const fragment = document.createDocumentFragment();

                quadrantTasks.forEach((task) => {
                    const isRunning = Timer.currentTask && Timer.currentTask.id === task.id;
                    const isOverdue = task.dueDate && !task.completed && new Date(task.dueDate) < new Date();

                    const taskWrapper = document.createElement('div');
                    taskWrapper.className = `task flex items-center justify-between p-3 transition duration-200 ease-in-out bg-white border-l-4 rounded-lg shadow-sm ${task.completed ? 'completed opacity-60' : ''} ${isRunning ? 'running' : ''} ${isOverdue ? 'overdue' : ''} quadrant-${task.quadrant}-border`;
                    taskWrapper.setAttribute('draggable', 'true');
                    taskWrapper.addEventListener('dragstart', (event) => TaskManager.dragStart(event, task.id));
                    taskWrapper.addEventListener('dragend', (event) => TaskManager.dragEnd(event));

                    const titleContainer = document.createElement('div');
                    titleContainer.className = 'flex-1 min-w-0 task-title';

                    if (this.editingTaskId === task.id) {
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.className = 'task-title-input';
                        input.dataset.taskId = String(task.id);
                        input.value = task.title;
                        input.addEventListener('blur', () => TaskManager.saveTaskTitle(task.id, input.value));
                        input.addEventListener('keydown', (event) => {
                            if (event.key === 'Enter') {
                                event.preventDefault();
                                input.blur();
                            }
                            if (event.key === 'Escape') {
                                TaskManager.editTask(null, event);
                            }
                        });
                        titleContainer.appendChild(input);
                    } else {
                        const titleText = document.createElement('p');
                        titleText.className = 'font-semibold text-gray-800 truncate task-title-text';
                        titleText.textContent = task.title;
                        titleText.addEventListener('click', (event) => TaskManager.editTask(task.id, event));
                        titleContainer.appendChild(titleText);
                    }

                    const meta = document.createElement('div');
                    meta.className = 'flex items-center gap-3 mt-1 text-xs text-gray-500 task-meta';
                    if (task.dueDate) {
                        const dueSpan = document.createElement('span');
                        dueSpan.textContent = `üìÖ ${new Date(task.dueDate).toLocaleDateString()}`;
                        meta.appendChild(dueSpan);
                    }
                    const timeSpan = document.createElement('span');
                    timeSpan.textContent = `‚è±Ô∏è ${task.timeBox}m`;
                    meta.appendChild(timeSpan);
                    titleContainer.appendChild(meta);

                    const actions = document.createElement('div');
                    actions.className = 'flex items-center gap-1 ml-2 task-actions';

                    const startButton = document.createElement('button');
                    startButton.type = 'button';
                    startButton.title = 'Start Timer';
                    startButton.className = 'p-1 text-gray-400 rounded-full task-btn hover:bg-gray-200 hover:text-yellow-500';
                    startButton.textContent = '‚è±Ô∏è';
                    startButton.addEventListener('click', (event) => Timer.startFromTask(task.id, event));

                    const detailsButton = document.createElement('button');
                    detailsButton.type = 'button';
                    detailsButton.title = 'Edit Details';
                    detailsButton.className = 'p-1 text-gray-400 rounded-full task-btn hover:bg-gray-200 hover:text-blue-500';
                    detailsButton.textContent = 'üìù';
                    detailsButton.addEventListener('click', (event) => UI.openDetailsModal(task.id, event));

                    const toggleButton = document.createElement('button');
                    toggleButton.type = 'button';
                    toggleButton.title = `Mark as ${task.completed ? 'Incomplete' : 'Complete'}`;
                    toggleButton.className = 'p-1 text-gray-400 rounded-full task-btn hover:bg-gray-200';
                    toggleButton.textContent = task.completed ? '‚Ü©Ô∏è' : '‚úÖ';
                    toggleButton.addEventListener('click', (event) => TaskManager.toggleComplete(task.id, event));

                    const deleteButton = document.createElement('button');
                    deleteButton.type = 'button';
                    deleteButton.title = 'Delete Task';
                    deleteButton.className = 'p-1 text-gray-400 rounded-full task-btn hover:bg-gray-200 hover:text-red-500';
                    deleteButton.textContent = 'üóëÔ∏è';
                    deleteButton.addEventListener('click', (event) => TaskManager.deleteTask(task.id, event));

                    actions.append(startButton, detailsButton, toggleButton, deleteButton);

                    taskWrapper.append(titleContainer, actions);
                    fragment.appendChild(taskWrapper);
                });

                container.appendChild(fragment);
            }
        },
    };
    TaskManager.init();

    (function () {
        const warning = document.getElementById('configWarning');
        if (typeof google !== 'undefined' && google.script && google.script.host) {
            try {
                google.script.host.setHeight(640);
            } catch (err) {
                console.warn('Unable to set sidebar height', err);
            }
        } else if (warning) {
            warning.textContent = 'To use this dashboard inside Google Sheets, import both "Code.gs" and "index.html" into an Apps Script project and open it from the custom "Eisenhower Matrix" menu.';
            warning.classList.remove('hidden');
        }
    })();
    </script>
</body>
</html>
