<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Eisenhower Matrix - Smart Task Manager</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <style>
        :root {
            --q1-color: #dc2626; --q1-light: #fecaca; --q1-dark: #991b1b;
            --q2-color: #2563eb; --q2-light: #bfdbfe; --q2-dark: #1d4ed8;
            --q3-color: #f59e0b; --q3-light: #fde68a; --q3-dark: #d97706;
            --q4-color: #6b7280; --q4-light: #e5e7eb; --q4-dark: #4b5563;
            --google-blue: #4285F4; --google-blue-dark: #3367D6;
            --success: #10b981; --bg: #f8fafc; --card: #ffffff;
            --text: #1f2937; --text-light: #6b7280; --border: #e5e7eb;
            --shadow: 0 1px 3px rgba(0,0,0,0.1); --shadow-lg: 0 4px 20px rgba(0,0,0,0.15);
            --error-bg: #fef2f2; --error-text: #991b1b; --error-border: #fecaca;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; color: var(--text); overflow-x: hidden;
            touch-action: manipulation; -webkit-tap-highlight-color: transparent;
        }
        
        /* Configuration Warning */
        .config-warning {
            display: none; padding: 12px; background-color: var(--error-bg);
            color: var(--error-text); border-bottom: 2px solid var(--error-border);
            text-align: center; font-size: 14px; font-weight: 500;
        }
        .config-warning.visible { display: block; }
        .config-warning a { color: var(--q2-dark); font-weight: 600; text-decoration: underline; }

        .app { max-width: 100vw; margin: 0 auto; padding: 12px; }

        /* Header */
        .header { 
            text-align: center; margin-bottom: 20px; color: white;
            padding: 16px 12px;
        }
        .header h1 { 
            font-size: clamp(1.5rem, 4vw, 2.5rem); font-weight: 700; 
            margin-bottom: 8px; text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .header p { font-size: clamp(0.875rem, 2.5vw, 1rem); opacity: 0.9; }
        
        /* Auth Section */
        .auth-section {
            display: flex; justify-content: center; align-items: center;
            gap: 12px; margin-top: 16px; min-height: 40px;
        }
        .user-profile { display: flex; align-items: center; gap: 8px; }
        .user-profile img { width: 32px; height: 32px; border-radius: 50%; border: 2px solid white; }
        .user-profile span { font-weight: 600; }
        .google-btn {
            background-color: var(--google-blue); color: white; border: none;
            border-radius: 8px; padding: 10px 16px; font-size: 14px;
            font-weight: 600; cursor: pointer; display: flex;
            align-items: center; gap: 8px; transition: background-color 0.2s ease;
        }
        .google-btn:hover { background-color: var(--google-blue-dark); }
        .google-btn:disabled { background-color: var(--q4-color); cursor: not-allowed; }
        .google-btn.sign-out { background-color: var(--q4-color); }
        .google-btn.sign-out:hover { background-color: var(--q4-dark); }
        .google-btn svg { width: 18px; height: 18px; }

        /* Quick Add */
        .quick-add {
            background: var(--card); border-radius: 16px; 
            padding: 16px; margin-bottom: 16px; box-shadow: var(--shadow-lg);
        }
        .add-form { display: flex; flex-direction: column; gap: 12px; }
        .form-row { display: grid; grid-template-columns: 2fr 1fr; gap: 8px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { 
            font-size: 0.75rem; font-weight: 600; 
            margin-bottom: 4px; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.05em;
        }
        
        input, select, button {
            border: 2px solid var(--border); border-radius: 8px;
            padding: 12px; font-size: 14px; background: white;
            transition: all 0.2s ease; outline: none;
        }
        
        input:focus, select:focus {
            border-color: var(--q2-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .btn {
            cursor: pointer; font-weight: 600; border: none;
            display: flex; align-items: center; justify-content: center; gap: 6px;
            min-height: 44px; /* Touch target */
        }
        .btn-primary { 
            background: var(--q2-color); color: white;
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
        }
        .btn-primary:hover { background: var(--q2-dark); transform: translateY(-1px); }
        
        /* Matrix */
        .matrix {
            display: grid; gap: 12px;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        }

        .quadrant {
            background: var(--card); border-radius: 16px; 
            padding: 16px; min-height: 320px; position: relative;
            box-shadow: var(--shadow-lg); transition: transform 0.2s ease;
            border-top: 4px solid var(--border);
        }
        .quadrant:hover { transform: translateY(-2px); }
        .quadrant.drag-over { 
            border-color: var(--q2-color); background: var(--q2-light);
            transform: scale(1.02);
        }

        .quadrant-1 { border-top-color: var(--q1-color); }
        .quadrant-2 { border-top-color: var(--q2-color); }
        .quadrant-3 { border-top-color: var(--q3-color); }
        .quadrant-4 { border-top-color: var(--q4-color); }

        .quadrant-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid var(--border);
        }
        .quadrant-title { font-size: 1rem; font-weight: 700; }
        .quadrant-1 .quadrant-title { color: var(--q1-color); }
        .quadrant-2 .quadrant-title { color: var(--q2-color); }
        .quadrant-3 .quadrant-title { color: var(--q3-color); }
        .quadrant-4 .quadrant-title { color: var(--q4-color); }

        .task-count {
            padding: 4px 8px; border-radius: 12px; font-size: 0.75rem;
            font-weight: 600; color: white; min-width: 24px; text-align: center;
        }
        .quadrant-1 .task-count { background: var(--q1-color); }
        .quadrant-2 .task-count { background: var(--q2-color); }
        .quadrant-3 .task-count { background: var(--q3-color); }
        .quadrant-4 .task-count { background: var(--q4-color); }

        /* Tasks */
        .task {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg); border-radius: 8px; padding: 12px;
            margin-bottom: 8px; cursor: pointer; position: relative;
            transition: all 0.2s ease; border-left: 4px solid transparent; min-height: 60px;
        }
        .task:hover { transform: translateX(2px); box-shadow: var(--shadow); }
        .task:active { cursor: grabbing; }

        .quadrant-1 .task { border-left-color: var(--q1-color); }
        .quadrant-2 .task { border-left-color: var(--q2-color); }
        .quadrant-3 .task { border-left-color: var(--q3-color); }
        .quadrant-4 .task { border-left-color: var(--q4-color); }

        .task.completed { opacity: 0.6; }
        .task.completed .task-title-text { text-decoration: line-through; }
        .task.running { background: var(--q2-light); box-shadow: 0 0 0 2px var(--q2-color), var(--shadow); }
       
        .task-title { flex: 1; margin-right: 8px; }
        .task-title-text { font-weight: 600; line-height: 1.3; }
        .task-meta { font-size: 0.75rem; color: var(--text-light); display: flex; gap: 8px; margin-top: 6px; flex-wrap: wrap; }
        .task-meta span { background: rgba(0,0,0,0.05); padding: 2px 6px; border-radius: 4px; }
        .remaining-time { background: var(--q3-color) !important; color: white; }
        
        .task-actions { display: flex; gap: 4px; opacity: 0; transition: opacity 0.2s ease; }
        .task:hover .task-actions, .task:focus-within .task-actions { opacity: 1; }

        .task-btn {
            background: none; border: none; padding: 6px; border-radius: 4px;
            cursor: pointer; font-size: 14px; transition: all 0.2s ease;
            min-width: 32px; min-height: 32px; display: flex; align-items: center; justify-content: center;
            color: var(--text-light);
        }
        .task-btn:hover { background: rgba(0,0,0,0.1); color: var(--text); }
        .task-btn.google-action { font-size: 18px; }
        .task-btn:disabled { cursor: not-allowed; opacity: 0.4; }

        .empty-state { text-align: center; color: var(--text-light); padding: 40px 20px; font-style: italic; }
        
        /* Timer Modal */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 1000; align-items: center; justify-content: center;
            backdrop-filter: blur(8px); padding: 20px;
        }
        .modal.active { display: flex; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        .timer-modal {
            background: var(--card); border-radius: 24px; padding: 24px;
            max-width: 400px; width: 100%; text-align: center;
            box-shadow: var(--shadow-lg); position: relative;
        }
        .timer-header { margin-bottom: 16px; }
        .timer-title { font-size: 1.2rem; font-weight: 700; margin-bottom: 4px; color: var(--text); }
        .timer-subtitle { font-size: 0.875rem; color: var(--text-light); display: flex; justify-content: center; gap: 12px; }
        .timer-circle {
            width: 180px; height: 180px; margin: 20px auto; position: relative;
            border-radius: 50%; background: conic-gradient(from 0deg, var(--q2-color) 0%, var(--border) 0%);
            display: flex; align-items: center; justify-content: center;
        }
        .timer-inner {
            width: 140px; height: 140px; border-radius: 50%;
            background: var(--card); display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.1);
        }
        .timer-display { font-size: 2rem; font-weight: 700; color: var(--q2-color); font-family: 'Courier New', monospace; }
        .timer-status { font-size: 0.75rem; color: var(--text-light); margin-top: 4px; }
        .timer-controls { display: flex; gap: 8px; justify-content: center; margin-top: 20px; }
        .timer-btn {
            padding: 10px 16px; border: none; border-radius: 8px;
            font-weight: 600; cursor: pointer; transition: all 0.2s ease;
        }
        .timer-btn.start { background: var(--success); color: white; }
        .timer-btn.pause { background: var(--q3-color); color: white; }
        .timer-btn.stop { background: var(--q1-color); color: white; }
        .timer-btn:hover { transform: translateY(-1px); filter: brightness(1.1); }

        /* Notifications */
        .notification {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 1001;
            background: var(--card); border-radius: 8px; padding: 12px 16px;
            box-shadow: var(--shadow-lg); border-top: 4px solid var(--success);
            opacity: 0; transition: all 0.3s ease; max-width: 90%; width: 400px;
        }
        .notification.show { opacity: 1; transform: translate(-50%, -10px); }
        .notification.error { border-top-color: var(--q1-color); }

        /* Responsive Breakpoints */
        @media (max-width: 480px) {
            .app { padding: 8px; }
            .form-row { grid-template-columns: 1fr; }
            .matrix { grid-template-columns: 1fr; }
            .timer-circle { width: 140px; height: 140px; }
            .timer-inner { width: 110px; height: 110px; }
            .timer-display { font-size: 1.5rem; }
        }

        @media (min-width: 1024px) {
            .add-form { flex-direction: row; align-items: end; }
        }
    </style>
</head>
<body>
    <div id="configWarning" class="config-warning">
        <strong>Configuration Required:</strong> Please update the <code>GOOGLE_CLIENT_ID</code> in the script to enable Google Sign-In and integration features. 
        You can get a Client ID from the <a href="https://console.cloud.google.com/apis/credentials" target="_blank" rel="noopener noreferrer">Google Cloud Console</a>.
    </div>

    <div class="app">
        <!-- Header -->
        <header class="header">
            <h1>🎯 Eisenhower Matrix</h1>
            <p>Focus on what matters, powered by Google.</p>
            <div class="auth-section" id="authSection"></div>
        </header>

        <!-- Quick Add -->
        <section class="quick-add">
            <form id="addTaskForm" class="add-form" onsubmit="TaskManager.addTask(event)">
                <div class="form-group" style="flex: 2;">
                    <label for="taskTitle">Task</label>
                    <input type="text" id="taskTitle" placeholder="What needs to be done?" required>
                </div>
                <div class="form-row" style="flex: 1.5;">
                    <div class="form-group">
                        <label for="taskQuadrant">Priority</label>
                        <select id="taskQuadrant">
                            <option value="1">🔥 Urgent & Important</option>
                            <option value="2" selected>📅 Important</option>
                            <option value="3">⚡ Urgent</option>
                            <option value="4">🗑️ Neither</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="taskTime">Minutes</label>
                        <input type="number" id="taskTime" value="25" min="5">
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">➕ Add Task</button>
            </form>
        </section>

        <!-- Matrix -->
        <main class="matrix">
            <div class="quadrant quadrant-1" data-quadrant="1" ondrop="TaskManager.drop(event)" ondragover="TaskManager.allowDrop(event)">
                <div class="quadrant-header"><div class="quadrant-title">🔥 Do First</div><div class="task-count" id="count-1">0</div></div>
                <div class="tasks-container" id="tasks-1"></div>
            </div>
            <div class="quadrant quadrant-2" data-quadrant="2" ondrop="TaskManager.drop(event)" ondragover="TaskManager.allowDrop(event)">
                <div class="quadrant-header"><div class="quadrant-title">📅 Schedule</div><div class="task-count" id="count-2">0</div></div>
                <div class="tasks-container" id="tasks-2"></div>
            </div>
            <div class="quadrant quadrant-3" data-quadrant="3" ondrop="TaskManager.drop(event)" ondragover="TaskManager.allowDrop(event)">
                <div class="quadrant-header"><div class="quadrant-title">⚡ Delegate</div><div class="task-count" id="count-3">0</div></div>
                <div class="tasks-container" id="tasks-3"></div>
            </div>
            <div class="quadrant quadrant-4" data-quadrant="4" ondrop="TaskManager.drop(event)" ondragover="TaskManager.allowDrop(event)">
                <div class="quadrant-header"><div class="quadrant-title">🗑️ Eliminate</div><div class="task-count" id="count-4">0</div></div>
                <div class="tasks-container" id="tasks-4"></div>
            </div>
        </main>
    </div>
    
    <!-- Timer Modal -->
    <div class="modal" id="timerModal">
        <div class="timer-modal">
            <div class="timer-header">
                <div class="timer-title" id="timerTitle">Focus Timer</div>
                <div class="timer-subtitle">
                    <span id="timerQuadrant"></span>
                    <span id="timerDuration"></span>
                </div>
            </div>
            <div class="timer-circle" id="timerCircle">
                <div class="timer-inner">
                    <div class="timer-display" id="timerDisplay">25:00</div>
                    <div class="timer-status" id="timerStatus">Ready</div>
                </div>
            </div>
            <div class="timer-controls">
                <button class="timer-btn start" id="startBtn" onclick="Timer.start()">▶️ Start</button>
                <button class="timer-btn pause" id="pauseBtn" onclick="Timer.pause()" style="display: none;">⏸️ Pause</button>
                <button class="timer-btn stop" onclick="Timer.stop()">⏹️ Stop</button>
            </div>
            <button onclick="Timer.close()" style="margin-top: 16px; background: none; border: none; color: var(--text-light); cursor: pointer; font-size: 14px;">✕ Close</button>
        </div>
    </div>

    <script>
    // --- CONFIGURATION --- //
    const GOOGLE_CLIENT_ID = "434910578368-6ura496r68hb9onic2osm71c9es9ap8p.apps.googleusercontent.com";
    const CALENDAR_ID = 'primary'; 

    // --- GOOGLE AUTH & API HANDLER --- //
    const GoogleService = {
        tokenClient: null, isGapiLoaded: false, isLoggedIn: false, userProfile: null,
        init() {
            window.onload = () => {
                if (GOOGLE_CLIENT_ID === 'YOUR_CLIENT_ID.apps.googleusercontent.com') {
                    document.getElementById('configWarning').classList.add('visible');
                    document.querySelector('.auth-section').innerHTML = `<button class="google-btn" disabled>Setup Required</button>`;
                    document.getElementById('addTaskForm').querySelectorAll('input, select, button').forEach(el => el.disabled = true);
                    return;
                }
                google.accounts.id.initialize({ client_id: GOOGLE_CLIENT_ID, callback: this.handleCredentialResponse.bind(this) });
                this.renderSignInButton();
                gapi.load('client', this.initGapiClient.bind(this));
            };
        },
        async initGapiClient() {
            await gapi.client.init({ discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest", "https://www.googleapis.com/discovery/v1/apis/tasks/v1/rest"] });
            this.isGapiLoaded = true;
        },
        handleCredentialResponse(response) {
            this.userProfile = this.decodeJwt(response.credential);
            this.isLoggedIn = true;
            this.tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: GOOGLE_CLIENT_ID,
                scope: 'https://www.googleapis.com/auth/calendar https://www.googleapis.com/auth/tasks',
                callback: '',
            });
            this.updateUIAfterLogin();
            TaskManager.render();
        },
        _makeApiCall(callback) {
            if (!this.isLoggedIn || !this.tokenClient) { UI.showNotification("Please sign in to use Google features.", "error"); return; }
            this.tokenClient.callback = (tokenResponse) => {
                if (tokenResponse && tokenResponse.access_token) { gapi.client.setToken(tokenResponse); callback(); } 
                else { console.error("Authorization failed.", tokenResponse); UI.showNotification("Google authorization failed. Please try signing in again.", "error"); }
            };
            if (gapi.client.getToken()) { callback(); } else { this.tokenClient.requestAccessToken({ prompt: '' }); }
        },
        addToCalendar(task) {
            this._makeApiCall(async () => {
                const event = {
                    'summary': task.title,
                    'description': `An Eisenhower Matrix task. Quadrant: ${task.quadrant}`,
                    'start': { 'dateTime': new Date().toISOString(), 'timeZone': Intl.DateTimeFormat().resolvedOptions().timeZone },
                    'end': { 'dateTime': new Date(new Date().getTime() + task.timeBox * 60000).toISOString(), 'timeZone': Intl.DateTimeFormat().resolvedOptions().timeZone },
                };
                try {
                    await gapi.client.calendar.events.insert({ 'calendarId': CALENDAR_ID, 'resource': event });
                    UI.showNotification("Task added to Google Calendar!", "success");
                } catch (err) { console.error("Error adding to calendar:", err); UI.showNotification("Could not add to Calendar.", "error"); }
            });
        },
        addToTasks(task) {
            this._makeApiCall(async () => {
                const taskResource = {
                    'title': task.title,
                    'notes': `Eisenhower Matrix Quadrant: ${task.quadrant}`,
                    'due': new Date(new Date().getTime() + 24 * 60 * 60000).toISOString()
                };
                try {
                    await gapi.client.tasks.tasks.insert({ tasklist: '@default', resource: taskResource });
                    UI.showNotification("Task added to Google Tasks!", "success");
                } catch (err) { console.error("Error adding to tasks:", err); UI.showNotification("Could not add to Tasks.", "error"); }
            });
        },
        signIn() {
            if (google.accounts.id) { google.accounts.id.prompt(); } 
            else { UI.showNotification("Google Sign-In is not ready yet.", "error"); }
        },
        signOut() {
            if (gapi.client.getToken()) { google.accounts.oauth2.revoke(gapi.client.getToken().access_token, () => {}); gapi.client.setToken(null); }
            google.accounts.id.disableAutoSelect();
            this.isLoggedIn = false; this.userProfile = null; this.tokenClient = null;
            this.renderSignInButton(); TaskManager.render(); UI.showNotification("You have been signed out.");
        },
        renderSignInButton() {
            document.getElementById('authSection').innerHTML = `<button class="google-btn" onclick="GoogleService.signIn()"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M21.35,11.1H12.18V13.83H18.69C18.36,17.64 15.19,19.27 12.19,19.27C8.36,19.27 5,16.25 5,12C5,7.9 8.2,4.73 12.19,4.73C15.29,4.73 17.1,6.7 17.1,6.7L19,4.72C19,4.72 16.56,2 12.19,2C6.42,2 2.03,6.8 2.03,12C2.03,17.05 6.16,22 12.19,22C17.6,22 21.54,18.33 21.54,12.25C21.54,11.66 21.48,11.38 21.35,11.1Z"></path></svg> Sign in with Google</button>`;
        },
        updateUIAfterLogin() {
            document.getElementById('authSection').innerHTML = `<div class="user-profile"><img src="${this.userProfile.picture}" alt="User profile picture"><span>${this.userProfile.name}</span></div><button class="google-btn sign-out" onclick="GoogleService.signOut()">Sign Out</button>`;
        },
        decodeJwt(token) {
            var base64Url = token.split('.')[1]; var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            var jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) { return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2); }).join(''));
            return JSON.parse(jsonPayload);
        }
    };
    GoogleService.init();

    // --- TIMER --- //
    const Timer = {
        currentTask: null, duration: 0, remaining: 0, interval: null, isRunning: false,
        startFromTask(taskId) {
            const task = TaskManager.tasks.find(t => t.id === taskId);
            if (!task) return;
            // Prevent starting timer if an action button was clicked
            if (window.event.target.closest('.task-actions')) return;
            this.currentTask = task;
            this.duration = task.timeBox * 60;
            this.remaining = task.remainingTime || this.duration;
            this.showModal();
            this.start();
        },
        start() {
            if (this.isRunning || !this.currentTask) return;
            this.isRunning = true;
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('pauseBtn').style.display = 'inline-flex';
            document.getElementById('timerStatus').textContent = 'Focusing...';
            this.interval = setInterval(() => {
                this.remaining--;
                this.currentTask.remainingTime = this.remaining;
                this.updateDisplay();
                if (this.remaining <= 0) { this.complete(); }
            }, 1000);
            TaskManager.saveAndRender();
        },
        pause() {
            if (!this.isRunning) return;
            this.isRunning = false;
            clearInterval(this.interval);
            document.getElementById('startBtn').style.display = 'inline-flex';
            document.getElementById('pauseBtn').style.display = 'none';
            document.getElementById('timerStatus').textContent = 'Paused';
            TaskManager.saveAndRender();
        },
        stop() {
            if (this.currentTask) {
                 delete this.currentTask.remainingTime;
                 this.currentTask = null;
            }
            this.close();
        },
        complete() {
            UI.showNotification(`Timer for "${this.currentTask.title}" complete!`, 'success');
            this.stop();
        },
        showModal() {
            const quadrantNames = {1: '🔥 Do First', 2: '📅 Schedule', 3: '⚡ Delegate', 4: '🗑️ Eliminate'};
            document.getElementById('timerTitle').textContent = this.currentTask.title;
            document.getElementById('timerQuadrant').textContent = quadrantNames[this.currentTask.quadrant];
            document.getElementById('timerDuration').textContent = `${this.currentTask.timeBox} minutes`;
            document.getElementById('timerModal').classList.add('active');
            this.updateDisplay();
        },
        close() {
            this.isRunning = false;
            clearInterval(this.interval);
            document.getElementById('timerModal').classList.remove('active');
            TaskManager.saveAndRender();
        },
        updateDisplay() {
            const minutes = Math.floor(this.remaining / 60);
            const seconds = this.remaining % 60;
            document.getElementById('timerDisplay').textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            const progress = ((this.duration - this.remaining) / this.duration) * 100;
            document.getElementById('timerCircle').style.background = `conic-gradient(from 0deg, var(--q2-color) ${progress}%, var(--border) ${progress}%)`;
        }
    };

    // --- TASK MANAGER --- //
    const TaskManager = {
        tasks: JSON.parse(localStorage.getItem('tasks')) || [],
        idCounter: parseInt(localStorage.getItem('idCounter')) || 1,
        addTask(event) {
            event.preventDefault();
            const title = document.getElementById('taskTitle').value.trim();
            if (!title) return;
            const task = {
                id: this.idCounter++, title,
                timeBox: parseInt(document.getElementById('taskTime').value) || 25,
                quadrant: parseInt(document.getElementById('taskQuadrant').value),
                completed: false, createdAt: new Date().toISOString(),
            };
            this.tasks.push(task);
            this.saveAndRender();
            event.target.reset();
        },
        deleteTask(taskId) {
            event.stopPropagation();
            if (confirm('Are you sure you want to delete this task?')) {
                this.tasks = this.tasks.filter(t => t.id !== taskId);
                this.saveAndRender();
            }
        },
        toggleComplete(taskId) {
            event.stopPropagation();
            const task = this.tasks.find(t => t.id == taskId);
            if(task) { task.completed = !task.completed; this.saveAndRender(); }
        },
        moveTask(taskId, newQuadrant) {
            const task = this.tasks.find(t => t.id == taskId);
            if (task) { task.quadrant = newQuadrant; this.saveAndRender(); }
        },
        dragStart(event, taskId) { 
            event.stopPropagation();
            event.dataTransfer.setData('text/plain', taskId); 
        },
        allowDrop(event) { event.preventDefault(); event.currentTarget.classList.add('drag-over'); },
        drop(event) {
            event.preventDefault(); event.currentTarget.classList.remove('drag-over');
            const taskId = event.dataTransfer.getData('text/plain');
            const newQuadrant = parseInt(event.currentTarget.dataset.quadrant);
            this.moveTask(taskId, newQuadrant);
        },
        saveAndRender() {
            localStorage.setItem('tasks', JSON.stringify(this.tasks));
            localStorage.setItem('idCounter', this.idCounter);
            this.render();
        },
        render() {
            for (let i = 1; i <= 4; i++) {
                const container = document.getElementById(`tasks-${i}`);
                const quadrantTasks = this.tasks.filter(t => t.quadrant == i);
                document.getElementById(`count-${i}`).textContent = quadrantTasks.length;
                if (quadrantTasks.length === 0) {
                    container.innerHTML = `<div class="empty-state">No tasks here.</div>`;
                    continue;
                }
                container.innerHTML = quadrantTasks.map(task => {
                    const isRunning = Timer.currentTask && Timer.currentTask.id === task.id && Timer.isRunning;
                    return `
                    <div class="task ${task.completed ? 'completed' : ''} ${isRunning ? 'running' : ''}" 
                         draggable="true" 
                         ondragstart="TaskManager.dragStart(event, ${task.id})"
                         onclick="Timer.startFromTask(${task.id})">
                        <div class="task-title">
                           <div class="task-title-text">${task.title}</div>
                           <div class="task-meta">
                                <span>⏱️ ${task.timeBox}min</span>
                                ${task.remainingTime ? `<span class="remaining-time">⏰ ${Math.floor(task.remainingTime / 60)}min left</span>` : ''}
                           </div>
                        </div>
                        <div class="task-actions">
                            <button class="task-btn google-action" title="Add to Google Calendar" onclick='event.stopPropagation(); GoogleService.addToCalendar(${JSON.stringify(task)})' ${!GoogleService.isLoggedIn ? 'disabled' : ''}>📅</button>
                            <button class="task-btn google-action" title="Add to Google Tasks" onclick='event.stopPropagation(); GoogleService.addToTasks(${JSON.stringify(task)})' ${!GoogleService.isLoggedIn ? 'disabled' : ''}>✔️</button>
                            <button class="task-btn" title="Mark as ${task.completed ? 'Incomplete' : 'Complete'}" onclick="TaskManager.toggleComplete(${task.id})">${task.completed ? '↩️' : '✅'}</button>
                            <button class="task-btn" title="Delete Task" onclick="TaskManager.deleteTask(${task.id})">🗑️</button>
                        </div>
                    </div>
                `}).join('');
            }
        },
    };
    TaskManager.render();

    // --- UI UTILITIES --- //
    const UI = {
        showNotification(message, type = 'success') {
            document.querySelectorAll('.notification').forEach(n => n.remove());
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.classList.add('show'), 10);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 4000);
        }
    };

    // Global drag leave handler
    document.addEventListener('dragleave', (e) => {
        if (e.target.classList.contains('quadrant')) {
            e.target.classList.remove('drag-over');
        }
    });
    </script>
</body>
</html>
